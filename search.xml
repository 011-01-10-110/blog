<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>远程搜索下拉框封装</title>
      <link href="/2023/08/01/%E8%BF%9C%E7%A8%8B%E6%90%9C%E7%B4%A2%E4%B8%8B%E6%8B%89%E6%A1%86%E5%B0%81%E8%A3%85/"/>
      <url>/2023/08/01/%E8%BF%9C%E7%A8%8B%E6%90%9C%E7%B4%A2%E4%B8%8B%E6%8B%89%E6%A1%86%E5%B0%81%E8%A3%85/</url>
      
        <content type="html"><![CDATA[<h2 id="远程搜索下拉框封装"><a href="#远程搜索下拉框封装" class="headerlink" title="远程搜索下拉框封装"></a>远程搜索下拉框封装</h2><p>首先要有需求，需求驱使才能让我们打工人创造业务组件</p><h3 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h3><p>我们平时做一些管理系统之类的应用时都需要一些关联搜索的下拉选择，所以就需要我们写很多下拉相关的业务组件</p><h3 id="方案选择"><a href="#方案选择" class="headerlink" title="方案选择"></a>方案选择</h3><p>思路呢，我暂时就想得到以下几套方案：</p><ul><li>所有的远程搜索下拉框都写一个组件</li><li>封装一个组件作为通用组件，通过props传参实现不同的搜索</li></ul><p>首先分析第一个方案，每个远程搜索都写一个独立的组件。</p><ul><li>优点：很明显不用考虑别的就实现输入和输出就完事了；</li><li>缺点：就是会制造大量的重复代码，以及很多组件出来；</li></ul><p>第二个方案就是封装一个通用组件，不同的搜索传不同参数。</p><ul><li>优点：<ul><li>一个组件支撑某些情况下更改起来会相对便捷</li><li>通过配置项实现不同的搜索下拉减少功能重复的组件</li></ul></li><li>缺点：<ul><li>编写起来需要考虑很多情况，很多奇怪的搜索可能照顾不到</li><li>需要的props可能会相对较多</li></ul></li></ul><h3 id="实现思路"><a href="#实现思路" class="headerlink" title="实现思路"></a>实现思路</h3><p>首先考虑远程搜索组件需要用到的必要的属性(element-plus的二次封装，所以它需要的属性以下不在过多赘述，会进行透传的)</p><p>这种组件实际需要的核心属性只包含以下几种：</p><table><thead><tr><th>props</th><th>说明</th><th>类型</th><th>默认值</th><th>是否必传</th></tr></thead><tbody><tr><td>modelValue</td><td>v-model绑定的值</td><td>Array/String/Number</td><td>-</td><td>是</td></tr><tr><td>url</td><td>后端提供的suggest接口</td><td>String</td><td>-</td><td>否</td></tr><tr><td>queryKey</td><td>suggest接口需要的联想传参字段名</td><td>String</td><td>-</td><td>否</td></tr><tr><td>selectOptionsKey</td><td>下拉option需要的label和value对应的接口返回的字段</td><td>[String, String]</td><td>[‘code’, ‘desc’]</td><td>否</td></tr><tr><td>multiple</td><td>是否多选</td><td>Boolean</td><td>false</td><td>否</td></tr><tr><td>selectDefaultOptions</td><td>默认的下拉框选项，不需要远程或者需要额外选项的时候可以传这个</td><td>Array</td><td>[]</td><td>否</td></tr></tbody></table><p>但是呢，只包含核心属性明显是不足以应付各种需求的，而且大部分场景都是和form表单一起用所以封一起更省事（写业务经常纠结各种场景判断导致时间不够用，所以还是得会偷懒啊）所以还提供下面一些额外的配置：</p><table><thead><tr><th>props</th><th>说明</th><th>类型</th><th>默认值</th></tr></thead><tbody><tr><td>desc</td><td>可选，可通过v-model绑定，下拉选项的展示的值</td><td>String/Array</td><td>-</td></tr><tr><td>label</td><td>form-item的label</td><td>String</td><td>-</td></tr><tr><td>rules</td><td>可选，form-item的rules</td><td>FormItemRule</td><td>-</td></tr><tr><td>prop</td><td>可选，form-item的prop</td><td>String</td><td>-</td></tr><tr><td>otherOptions</td><td>一些select相关的配置，都是可选的</td><td>Object</td><td>-</td></tr></tbody></table><p>otherOptions 配置项</p><table><thead><tr><th>props</th><th>说明</th><th>类型</th><th>默认值</th></tr></thead><tbody><tr><td>placeholder</td><td>占位文字</td><td>String / () =&gt; String</td><td>`请选择${props.label}`</td></tr><tr><td>remoteMethod</td><td>远程搜索方法，不满足通用的时候，自己定一个搜索方法</td><td>(query: string) =&gt; any[]</td><td>-</td></tr><tr><td>labelHandler</td><td>下拉选项的展示值处理</td><td>(option: Record&lt;string, T&gt;) =&gt; String</td><td>-</td></tr></tbody></table><h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><p>首先处理我们的props</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">SuggestProps</span> &#123;</span><br><span class="line">  desc?: <span class="built_in">string</span> | <span class="built_in">number</span> | <span class="title class_">Array</span>&lt;<span class="built_in">string</span> | <span class="built_in">number</span>&gt; | <span class="literal">undefined</span></span><br><span class="line">  <span class="attr">modelValue</span>: <span class="built_in">string</span> | <span class="built_in">number</span> | <span class="title class_">Array</span>&lt;<span class="built_in">string</span> | <span class="built_in">number</span>&gt;</span><br><span class="line">  <span class="attr">label</span>: <span class="built_in">string</span></span><br><span class="line">  multiple?: <span class="built_in">boolean</span></span><br><span class="line">  prop?: <span class="built_in">string</span></span><br><span class="line">  rules?: <span class="title class_">FormItemRule</span> | <span class="title class_">FormItemRule</span>[]</span><br><span class="line">  selectDefaultOptions?: <span class="title class_">SelectOptions</span>[]</span><br><span class="line">  url?: <span class="built_in">string</span></span><br><span class="line">  queryKey?: <span class="built_in">string</span></span><br><span class="line">  otherOptions?: <span class="built_in">any</span></span><br><span class="line">  selectOptionsKey?: [<span class="built_in">string</span>, <span class="built_in">string</span>]</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> props = <span class="title function_">withDefaults</span>(defineProps&lt;<span class="title class_">SuggestProps</span>&gt;(), &#123;</span><br><span class="line">  <span class="attr">desc</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  <span class="attr">selectDefaultOptions</span>: <span class="function">() =&gt;</span> [],</span><br><span class="line">  <span class="attr">multiple</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">url</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  <span class="attr">queryKey</span>: <span class="string">&#x27;name&#x27;</span>,</span><br><span class="line">  <span class="attr">selectOptionsKey</span>: <span class="function">() =&gt;</span> [<span class="string">&#x27;code&#x27;</span>, <span class="string">&#x27;desc&#x27;</span>],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>由于我目前只用得到双向绑定取值所以就定义了两个触发更新的emit</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">SuggestEmits</span> &#123;</span><br><span class="line">  (<span class="attr">event</span>: <span class="string">&#x27;update:modelValue&#x27;</span>, <span class="attr">e</span>: <span class="built_in">string</span> | <span class="built_in">number</span> | <span class="built_in">any</span>[]): <span class="built_in">void</span></span><br><span class="line">  (<span class="attr">event</span>: <span class="string">&#x27;update:desc&#x27;</span>, <span class="attr">e</span>: <span class="built_in">string</span> | <span class="built_in">number</span> | <span class="built_in">any</span>[] | <span class="literal">undefined</span>): <span class="built_in">void</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> emit = defineEmits&lt;<span class="title class_">SuggestEmits</span>&gt;();</span><br></pre></td></tr></table></figure><p>根据我们传入的props需要提取出一部分属性给el-select用</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; modelValue, label, rules, selectDefaultOptions, multiple, selectOptionsKey &#125; = <span class="title function_">toRefs</span>(props);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> loading = <span class="title function_">ref</span>(<span class="literal">false</span>);</span><br><span class="line"><span class="keyword">const</span> options = ref&lt;<span class="built_in">any</span>[]&gt;([]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> placeholder = <span class="title function_">computed</span>(<span class="function">() =&gt;</span> <span class="keyword">typeof</span> props?.<span class="property">otherOptions</span>?.<span class="property">placeholder</span> === <span class="string">&#x27;function&#x27;</span> ? props?.<span class="property">otherOptions</span>?.<span class="title function_">placeholder</span>() : <span class="title function_">t</span>(props?.<span class="property">otherOptions</span>?.<span class="property">placeholder</span> ?? <span class="string">&#x27;&#x27;</span>) || <span class="string">`<span class="subst">$&#123;t(<span class="string">&#x27;message.placeholder.placeSelect&#x27;</span>)&#125;</span><span class="subst">$&#123;t(props.label)&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> suggestOptions = <span class="title function_">reactive</span>(&#123;</span><br><span class="line">  <span class="attr">filterable</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">remote</span>: <span class="literal">true</span>,</span><br><span class="line">  multiple,</span><br><span class="line">  loading,</span><br><span class="line">  ...(<span class="title function_">isReactive</span>(props.<span class="property">otherOptions</span>) ? <span class="title function_">toRefs</span>(props.<span class="property">otherOptions</span>) : props.<span class="property">otherOptions</span>),</span><br><span class="line">  placeholder,</span><br><span class="line">  <span class="attr">clearable</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">remoteMethod</span>: <span class="keyword">async</span> (<span class="attr">query</span>: <span class="built_in">string</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (query) &#123;</span><br><span class="line">      loading.<span class="property">value</span> = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">if</span> (props.<span class="property">otherOptions</span>?.<span class="property">remoteMethod</span>) &#123;</span><br><span class="line">        options.<span class="property">value</span> = <span class="keyword">await</span> props.<span class="property">otherOptions</span>.<span class="title function_">remoteMethod</span>(query);</span><br><span class="line">        loading.<span class="property">value</span> = <span class="literal">false</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> data = <span class="keyword">await</span> $post(props.<span class="property">url</span>, &#123;</span><br><span class="line">          [props.<span class="property">queryKey</span>]: query,</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">if</span> (data?.<span class="property">code</span> === <span class="number">0</span>) &#123;</span><br><span class="line">          options.<span class="property">value</span> = data.<span class="property">info</span>.<span class="property">list</span>;</span><br><span class="line">          loading.<span class="property">value</span> = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      options.<span class="property">value</span> = [];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>以及一部分el-option需要的属性</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> options = ref&lt;<span class="built_in">any</span>[]&gt;([]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">labelView</span> = (<span class="params">item: EmptyObjectType</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (props?.<span class="property">otherOptions</span>?.<span class="property">labelHandler</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> props.<span class="property">otherOptions</span>.<span class="title function_">labelHandler</span>(item);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> item[selectOptionsKey.<span class="property">value</span>[<span class="number">1</span>]] ?? <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>模版代码如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">el-form-item</span> <span class="attr">:label</span>=<span class="string">&quot;`$&#123;$t(label)&#125;:`&quot;</span> <span class="attr">:rules</span>=<span class="string">&quot;rules&quot;</span> <span class="attr">:prop</span>=<span class="string">&quot;props.prop&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">el-select</span></span></span><br><span class="line"><span class="tag">      <span class="attr">:model-value</span>=<span class="string">&quot;modelValue&quot;</span></span></span><br><span class="line"><span class="tag">      @<span class="attr">update:model-value</span>=<span class="string">&quot;selectChange&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">v-bind</span>=<span class="string">&quot;suggestOptions&quot;</span></span></span><br><span class="line"><span class="tag">    &gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">el-option</span></span></span><br><span class="line"><span class="tag">        <span class="attr">v-for</span>=<span class="string">&quot;item in options&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">:key</span>=<span class="string">&quot;item[selectOptionsKey[0]]&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">:label</span>=<span class="string">&quot;item[selectOptionsKey[1]]&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">:value</span>=<span class="string">&quot;item[selectOptionsKey[0]]&quot;</span></span></span><br><span class="line"><span class="tag">      &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-html</span>=<span class="string">&quot;labelView(item)&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">el-option</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">el-select</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">el-form-item</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure><p>需要的属性都处理完后，我们该考虑如何处理选中的值如何向上层传递，如何处理上层传下来的数据回显问题了</p><p>首先我们需要知道我们设计将选中项的code(/id)和desc(选项描述)都存为了数组(/字符串)，那么我们就需要处理两种情况</p><ul><li>数组，也就是多选的情况，通过filter、配合includes过滤出选中的项</li><li>字符串，单选情况，通过find直接找到选中的项</li></ul><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">selectChange</span> = (<span class="params">e: <span class="built_in">any</span></span>) =&gt; &#123;</span><br><span class="line">  <span class="title function_">emit</span>(<span class="string">&#x27;update:modelValue&#x27;</span>, e);</span><br><span class="line">  <span class="keyword">if</span> (!multiple.<span class="property">value</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> desc = options.<span class="property">value</span>.<span class="title function_">find</span>(<span class="function"><span class="params">i</span> =&gt;</span> i[selectOptionsKey.<span class="property">value</span>[<span class="number">0</span>]] === e)?.[selectOptionsKey.<span class="property">value</span>[<span class="number">1</span>]];</span><br><span class="line">    <span class="title function_">emit</span>(<span class="string">&#x27;update:desc&#x27;</span>, desc);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> desc = options.<span class="property">value</span>.<span class="title function_">filter</span>(<span class="function"><span class="params">i</span> =&gt;</span> e.<span class="title function_">includes</span>(i[selectOptionsKey.<span class="property">value</span>[<span class="number">0</span>]])).<span class="title function_">map</span>(<span class="function"><span class="params">i</span> =&gt;</span> i[selectOptionsKey.<span class="property">value</span>[<span class="number">1</span>]]);</span><br><span class="line">    <span class="title function_">emit</span>(<span class="string">&#x27;update:desc&#x27;</span>, desc);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>目前来讲这个组件已经可以使用了，但是用起来会发现如果初始化的时候传入了modelValue和desc还是会出现选择框内只有code展示的问题，这个问题就是因为初始化的时候el-option是没有值的，这里用一个一次性的监听去处理下初始选项的问题就好了，如下为解决方案：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> cancelWatch = <span class="title function_">watch</span>(<span class="function">() =&gt;</span> props.<span class="property">desc</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (multiple.<span class="property">value</span> &amp;&amp; props.<span class="property">desc</span> &amp;&amp; <span class="keyword">typeof</span> props.<span class="property">modelValue</span> === <span class="string">&#x27;object&#x27;</span>) &#123;</span><br><span class="line">    props.<span class="property">modelValue</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">value, index</span>) =&gt;</span> &#123;</span><br><span class="line">      options.<span class="property">value</span>.<span class="title function_">push</span>(&#123; [selectOptionsKey.<span class="property">value</span>[<span class="number">0</span>]]: value, [selectOptionsKey.<span class="property">value</span>[<span class="number">1</span>]]: (props.<span class="property">desc</span> <span class="keyword">as</span> <span class="built_in">any</span>)?.[index] ?? value &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="title function_">nextTick</span>(<span class="function">() =&gt;</span> <span class="title function_">cancelWatch</span>());</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (props.<span class="property">desc</span>) &#123;</span><br><span class="line">    options.<span class="property">value</span>.<span class="title function_">push</span>(&#123; [selectOptionsKey.<span class="property">value</span>[<span class="number">0</span>]]: props.<span class="property">modelValue</span>, [selectOptionsKey.<span class="property">value</span>[<span class="number">1</span>]]: props.<span class="property">desc</span> &#125;);</span><br><span class="line">    <span class="title function_">nextTick</span>(<span class="function">() =&gt;</span> <span class="title function_">cancelWatch</span>());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, &#123; <span class="attr">immediate</span>: <span class="literal">true</span> &#125;);</span><br></pre></td></tr></table></figure><p>解决完初始选项和向上传递选中值的问题后，还要完善我们的默认选项的功能，这里通过watch监听这个props属性，如下：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">watch</span>(selectDefaultOptions, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  options.<span class="property">value</span> = [...options.<span class="property">value</span>, ...selectDefaultOptions.<span class="property">value</span>];</span><br><span class="line">&#125;, &#123; <span class="attr">immediate</span>: <span class="literal">true</span> &#125;);</span><br></pre></td></tr></table></figure><h3 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;el-form-item :label=&quot;`$&#123;$t(label)&#125;:`&quot; :rules=&quot;rules&quot; :prop=&quot;props.prop&quot;&gt;</span><br><span class="line">    &lt;el-select</span><br><span class="line">      :model-value=&quot;modelValue&quot;</span><br><span class="line">      @update:model-value=&quot;selectChange&quot;</span><br><span class="line">      v-bind=&quot;suggestOptions&quot;</span><br><span class="line">    &gt;</span><br><span class="line">      &lt;el-option</span><br><span class="line">        v-for=&quot;item in options&quot;</span><br><span class="line">        :key=&quot;item[selectOptionsKey[0]]&quot;</span><br><span class="line">        :label=&quot;item[selectOptionsKey[1]]&quot;</span><br><span class="line">        :value=&quot;item[selectOptionsKey[0]]&quot;</span><br><span class="line">      &gt;</span><br><span class="line">        &lt;div v-html=&quot;labelView(item)&quot;&gt;&lt;/div&gt;</span><br><span class="line">      &lt;/el-option&gt;</span><br><span class="line">    &lt;/el-select&gt;</span><br><span class="line">  &lt;/el-form-item&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;script setup lang=&quot;ts&quot; name=&quot;FrSuggest&quot;&gt;</span><br><span class="line">import &#123; $post &#125; from &#x27;@/plugins/axios&#x27;;</span><br><span class="line">import type &#123; FormItemRule &#125; from &#x27;element-plus&#x27;;</span><br><span class="line">import &#123; isReactive, nextTick, watch, ref, toRefs, reactive, computed &#125; from &#x27;vue&#x27;;</span><br><span class="line">import &#123; useI18n &#125; from &#x27;vue-i18n&#x27;;</span><br><span class="line"></span><br><span class="line">interface SuggestProps &#123;</span><br><span class="line">  desc?: string | number | Array&lt;string | number&gt; | undefined</span><br><span class="line">  modelValue: string | number | Array&lt;string | number&gt;</span><br><span class="line">  label: string</span><br><span class="line">  multiple?: boolean</span><br><span class="line">  prop?: string</span><br><span class="line">  rules?: FormItemRule | FormItemRule[]</span><br><span class="line">  selectDefaultOptions?: SelectOptions[]</span><br><span class="line">  url?: string</span><br><span class="line">  queryKey?: string</span><br><span class="line">  otherOptions?: any</span><br><span class="line">  selectOptionsKey?: [string, string]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface SuggestEmits &#123;</span><br><span class="line">  (event: &#x27;update:modelValue&#x27;, e: string | number | any[]): void</span><br><span class="line">  (event: &#x27;update:desc&#x27;, e: string | number | any[] | undefined): void</span><br><span class="line">&#125;</span><br><span class="line">const &#123; t &#125; = useI18n();</span><br><span class="line">const props = withDefaults(defineProps&lt;SuggestProps&gt;(), &#123;</span><br><span class="line">  desc: &#x27;&#x27;,</span><br><span class="line">  selectDefaultOptions: () =&gt; [],</span><br><span class="line">  multiple: false,</span><br><span class="line">  url: &#x27;&#x27;,</span><br><span class="line">  queryKey: &#x27;name&#x27;,</span><br><span class="line">  selectOptionsKey: () =&gt; [&#x27;code&#x27;, &#x27;desc&#x27;],</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">const &#123; modelValue, label, rules, selectDefaultOptions, multiple, selectOptionsKey &#125; = toRefs(props);</span><br><span class="line">const emit = defineEmits&lt;SuggestEmits&gt;();</span><br><span class="line"></span><br><span class="line">const loading = ref(false);</span><br><span class="line">const options = ref&lt;any[]&gt;([]);</span><br><span class="line"></span><br><span class="line">const placeholder = computed(() =&gt; typeof props?.otherOptions?.placeholder === &#x27;function&#x27; ? props?.otherOptions?.placeholder() : t(props?.otherOptions?.placeholder ?? &#x27;&#x27;) || `$&#123;t(&#x27;message.placeholder.placeSelect&#x27;)&#125;$&#123;t(props.label)&#125;`);</span><br><span class="line"></span><br><span class="line">const suggestOptions = reactive(&#123;</span><br><span class="line">  filterable: true,</span><br><span class="line">  remote: true,</span><br><span class="line">  multiple,</span><br><span class="line">  loading,</span><br><span class="line">  ...(isReactive(props.otherOptions) ? toRefs(props.otherOptions) : props.otherOptions),</span><br><span class="line">  placeholder,</span><br><span class="line">  clearable: true,</span><br><span class="line">  remoteMethod: async (query: string) =&gt; &#123;</span><br><span class="line">    if (query) &#123;</span><br><span class="line">      loading.value = true;</span><br><span class="line">      if (props.otherOptions?.remoteMethod) &#123;</span><br><span class="line">        options.value = await props.otherOptions.remoteMethod(query);</span><br><span class="line">        loading.value = false;</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        const data = await $post(props.url, &#123;</span><br><span class="line">          [props.queryKey]: query,</span><br><span class="line">        &#125;);</span><br><span class="line">        if (data?.code === 0) &#123;</span><br><span class="line">          options.value = data.info.list;</span><br><span class="line">          loading.value = false;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      options.value = [];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">const labelView = (item: EmptyObjectType) =&gt; &#123;</span><br><span class="line">  if (props?.otherOptions?.labelHandler) &#123;</span><br><span class="line">    return props.otherOptions.labelHandler(item);</span><br><span class="line">  &#125;</span><br><span class="line">  return item[selectOptionsKey.value[1]] ?? &#x27;&#x27;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">const selectChange = (e: any) =&gt; &#123;</span><br><span class="line">  emit(&#x27;update:modelValue&#x27;, e);</span><br><span class="line">  if (!multiple.value) &#123;</span><br><span class="line">    const desc = options.value.find(i =&gt; i[selectOptionsKey.value[0]] === e)?.[selectOptionsKey.value[1]];</span><br><span class="line">    emit(&#x27;update:desc&#x27;, desc);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    const desc = options.value.filter(i =&gt; e.includes(i[selectOptionsKey.value[0]])).map(i =&gt; i[selectOptionsKey.value[1]]);</span><br><span class="line">    emit(&#x27;update:desc&#x27;, desc);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">watch(selectDefaultOptions, () =&gt; &#123;</span><br><span class="line">  options.value = [...options.value, ...selectDefaultOptions.value];</span><br><span class="line">&#125;, &#123; immediate: true &#125;);</span><br><span class="line"></span><br><span class="line">const cancelWatch = watch(() =&gt; props.desc, () =&gt; &#123;</span><br><span class="line">  if (multiple.value &amp;&amp; props.desc &amp;&amp; typeof props.modelValue === &#x27;object&#x27;) &#123;</span><br><span class="line">    props.modelValue.forEach((value, index) =&gt; &#123;</span><br><span class="line">      options.value.push(&#123; [selectOptionsKey.value[0]]: value, [selectOptionsKey.value[1]]: (props.desc as any)?.[index] ?? value &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">    nextTick(() =&gt; cancelWatch());</span><br><span class="line">  &#125; else if (props.desc) &#123;</span><br><span class="line">    options.value.push(&#123; [selectOptionsKey.value[0]]: props.modelValue, [selectOptionsKey.value[1]]: props.desc &#125;);</span><br><span class="line">    nextTick(() =&gt; cancelWatch());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, &#123; immediate: true &#125;);</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>i18n为国际化翻译用的，不需要的请自行删除</p></blockquote>]]></content>
      
      
      
        <tags>
            
            <tag> 组件二次封装 </tag>
            
            <tag> suggest组件 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Vue-源码解析-2</title>
      <link href="/2023/07/25/Vue-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-2/"/>
      <url>/2023/07/25/Vue-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-2/</url>
      
        <content type="html"><![CDATA[<h2 id="Vue-Scheduler"><a href="#Vue-Scheduler" class="headerlink" title="Vue Scheduler"></a>Vue Scheduler</h2><p>Vue中的<code>Scheduler</code>(任务调度系统)，主要责任就是收集Vue在程序执行过程中产生的<code>Jobs</code>(任务)，让每个<code>Job</code>按照固定的顺序执行，避免资源的浪费和程序中的循环依赖导致的死循环。</p><p><code>Vue Scheduler</code>中的核心分为以下几个部分：</p><ul><li>任务队列(queue、pendingPostFlushCbs、activePostFlushCbs)</li><li>任务入队程序(queueJob， queuePostFlushCb)</li><li>任务执行状态(isFlushing、isFlushPending)</li><li>当前正在执行的任务Promise(currentFlushPromise)</li><li>任务执行程序(flushJobs、flushPostFlushCbs、flushPreFlushCbs)</li><li>任务优先级调配程序(comparator)</li></ul><blockquote><p>源码位置：packages/runtime-core/src/scheduler.ts</p></blockquote><h3 id="任务队列"><a href="#任务队列" class="headerlink" title="任务队列"></a>任务队列</h3><p>在<code>Vue Scheduler</code>中的所有任务分为<code>pre</code>、<code>普通任务</code>、<code>post</code>三种显式优先级，以及根据id进行排序的隐式优先级(主要用作将父组件任务前置，确保组件的任务链不会乱序)，如下所示：</p><ul><li><code>pre任务</code>和<code>普通任务</code>放在<code>queue</code>中</li><li><code>post任务</code>放在<code>pendingPostFlushCbs</code>以及<code>activePostFlushCbs</code>中</li></ul><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  flowchart TB  subgraph queue    pre任务    普通任务  end  subgraph pendingPostFlushCbs    post任务  end  subgraph activePostFlushCbs    正在执行的post任务  end  </pre></div><h3 id="任务的添加"><a href="#任务的添加" class="headerlink" title="任务的添加"></a>任务的添加</h3><p>在Vue执行的不同阶段都有任务产生，一部分任务会根据当时的配置立即执行或某些条件下随parent.update执行，另一部分会被添加到任务调度系统中进行统一的调度，以下为Vue中的入队方法：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/runtime-core/src/scheduler.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">queueJob</span>(<span class="params">job: SchedulerJob</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    !queue.<span class="property">length</span> ||</span><br><span class="line">    !queue.<span class="title function_">includes</span>(</span><br><span class="line">      job,</span><br><span class="line">      isFlushing &amp;&amp; job.<span class="property">allowRecurse</span> ? flushIndex + <span class="number">1</span> : flushIndex</span><br><span class="line">    )</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">if</span> (job.<span class="property">id</span> == <span class="literal">null</span>) &#123;</span><br><span class="line">      queue.<span class="title function_">push</span>(job)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      queue.<span class="title function_">splice</span>(<span class="title function_">findInsertionIndex</span>(job.<span class="property">id</span>), <span class="number">0</span>, job)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">queueFlush</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">queuePostFlushCb</span>(<span class="params">cb: SchedulerJobs</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="title function_">isArray</span>(cb)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      !activePostFlushCbs ||</span><br><span class="line">      !activePostFlushCbs.<span class="title function_">includes</span>(</span><br><span class="line">        cb,</span><br><span class="line">        cb.<span class="property">allowRecurse</span> ? postFlushIndex + <span class="number">1</span> : postFlushIndex</span><br><span class="line">      )</span><br><span class="line">    ) &#123;</span><br><span class="line">      pendingPostFlushCbs.<span class="title function_">push</span>(cb)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    pendingPostFlushCbs.<span class="title function_">push</span>(...cb)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">queueFlush</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="queueJob"><a href="#queueJob" class="headerlink" title="queueJob"></a>queueJob</h4><p>  在任务进入<code>queueJob</code>时会进行查重的判断，不存在才会将任务push或insert进<code>queue</code>，同时由watch进入的Job是允许递归调用自身的，这时需要开发者自己思考好自己的代码是否会无限执行。</p><ul><li><p>在renderer.ts的<code>setupRenderEffect</code>函数(处理组件渲染的核心函数)中会创建<code>update</code>对象，在<code>update</code>执行时任务会被收集到<code>queue</code>中，如下：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/runtime-core/src/renderer.ts</span></span><br><span class="line"><span class="comment">// create reactive effect for rendering</span></span><br><span class="line"><span class="keyword">const</span> effect = (instance.<span class="property">effect</span> = <span class="keyword">new</span> <span class="title class_">ReactiveEffect</span>(</span><br><span class="line">  componentUpdateFn,</span><br><span class="line">  <span class="function">() =&gt;</span> <span class="title function_">queueJob</span>(update),</span><br><span class="line">  instance.<span class="property">scope</span> <span class="comment">// track it in component&#x27;s effect scope</span></span><br><span class="line">))</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">const</span> <span class="attr">update</span>: <span class="title class_">SchedulerJob</span> = (instance.<span class="property">update</span> = <span class="function">() =&gt;</span> effect.<span class="title function_">run</span>())</span><br><span class="line">update.<span class="property">id</span> = instance.<span class="property">uid</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">update</span>()</span><br></pre></td></tr></table></figure></li><li><p>在this.$forceUpdate()执行时会被放入<code>queue</code>中，如下为Vue在this上拓展的属性其中就包含<code>$forceUpdate</code>：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/runtime-core/src/componentPublicInstance.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="attr">publicPropertiesMap</span>: <span class="title class_">PublicPropertiesMap</span> =</span><br><span class="line">  <span class="comment">// Move PURE marker to new line to workaround compiler discarding it</span></span><br><span class="line">  <span class="comment">// due to type annotation</span></span><br><span class="line">  <span class="comment">/*#__PURE__*/</span> <span class="title function_">extend</span>(<span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>), &#123;</span><br><span class="line">    <span class="attr">$</span>: <span class="function"><span class="params">i</span> =&gt;</span> i,</span><br><span class="line">    <span class="attr">$el</span>: <span class="function"><span class="params">i</span> =&gt;</span> i.<span class="property">vnode</span>.<span class="property">el</span>,</span><br><span class="line">    <span class="attr">$data</span>: <span class="function"><span class="params">i</span> =&gt;</span> i.<span class="property">data</span>,</span><br><span class="line">    <span class="attr">$props</span>: <span class="function"><span class="params">i</span> =&gt;</span> (__DEV__ ? <span class="title function_">shallowReadonly</span>(i.<span class="property">props</span>) : i.<span class="property">props</span>),</span><br><span class="line">    <span class="attr">$attrs</span>: <span class="function"><span class="params">i</span> =&gt;</span> (__DEV__ ? <span class="title function_">shallowReadonly</span>(i.<span class="property">attrs</span>) : i.<span class="property">attrs</span>),</span><br><span class="line">    <span class="attr">$slots</span>: <span class="function"><span class="params">i</span> =&gt;</span> (__DEV__ ? <span class="title function_">shallowReadonly</span>(i.<span class="property">slots</span>) : i.<span class="property">slots</span>),</span><br><span class="line">    <span class="attr">$refs</span>: <span class="function"><span class="params">i</span> =&gt;</span> (__DEV__ ? <span class="title function_">shallowReadonly</span>(i.<span class="property">refs</span>) : i.<span class="property">refs</span>),</span><br><span class="line">    <span class="attr">$parent</span>: <span class="function"><span class="params">i</span> =&gt;</span> <span class="title function_">getPublicInstance</span>(i.<span class="property">parent</span>),</span><br><span class="line">    <span class="attr">$root</span>: <span class="function"><span class="params">i</span> =&gt;</span> <span class="title function_">getPublicInstance</span>(i.<span class="property">root</span>),</span><br><span class="line">    <span class="attr">$emit</span>: <span class="function"><span class="params">i</span> =&gt;</span> i.<span class="property">emit</span>,</span><br><span class="line">    <span class="attr">$options</span>: <span class="function"><span class="params">i</span> =&gt;</span> (__FEATURE_OPTIONS_API__ ? <span class="title function_">resolveMergedOptions</span>(i) : i.<span class="property">type</span>),</span><br><span class="line">    <span class="attr">$forceUpdate</span>: <span class="function"><span class="params">i</span> =&gt;</span> i.<span class="property">f</span> || (i.<span class="property">f</span> = <span class="function">() =&gt;</span> <span class="title function_">queueJob</span>(i.<span class="property">update</span>)),</span><br><span class="line">    <span class="attr">$nextTick</span>: <span class="function"><span class="params">i</span> =&gt;</span> i.<span class="property">n</span> || (i.<span class="property">n</span> = nextTick.<span class="title function_">bind</span>(i.<span class="property">proxy</span>!)),</span><br><span class="line">    <span class="attr">$watch</span>: <span class="function"><span class="params">i</span> =&gt;</span> (__FEATURE_OPTIONS_API__ ? instanceWatch.<span class="title function_">bind</span>(i) : <span class="variable constant_">NOOP</span>)</span><br><span class="line">  &#125; <span class="keyword">as</span> <span class="title class_">PublicPropertiesMap</span>)</span><br></pre></td></tr></table></figure></li><li><p>异步组件加载时</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/runtime-core/src/apiAsyncComponent.ts</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="title function_">load</span>()</span><br><span class="line">.<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  loaded.<span class="property">value</span> = <span class="literal">true</span></span><br><span class="line">  <span class="keyword">if</span> (instance.<span class="property">parent</span> &amp;&amp; <span class="title function_">isKeepAlive</span>(instance.<span class="property">parent</span>.<span class="property">vnode</span>)) &#123;</span><br><span class="line">    <span class="comment">// parent is keep-alive, force update so the loaded component&#x27;s</span></span><br><span class="line">    <span class="comment">// name is taken into account</span></span><br><span class="line">    <span class="title function_">queueJob</span>(instance.<span class="property">parent</span>.<span class="property">update</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">onError</span>(err)</span><br><span class="line">  error.<span class="property">value</span> = err</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure></li><li><p>Watch执行时</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/runtime-core/src/apiWatch.ts</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">scheduler</span>: <span class="title class_">EffectScheduler</span></span><br><span class="line"><span class="keyword">if</span> (flush === <span class="string">&#x27;sync&#x27;</span>) &#123;</span><br><span class="line">  scheduler = job <span class="keyword">as</span> <span class="built_in">any</span> <span class="comment">// the scheduler function gets called directly</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (flush === <span class="string">&#x27;post&#x27;</span>) &#123;</span><br><span class="line">  scheduler = <span class="function">() =&gt;</span> <span class="title function_">queuePostRenderEffect</span>(job, instance &amp;&amp; instance.<span class="property">suspense</span>)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// default: &#x27;pre&#x27;</span></span><br><span class="line">  job.<span class="property">pre</span> = <span class="literal">true</span></span><br><span class="line">  <span class="keyword">if</span> (instance) job.<span class="property">id</span> = instance.<span class="property">uid</span></span><br><span class="line">  scheduler = <span class="function">() =&gt;</span> <span class="title function_">queueJob</span>(job)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure></li><li><p>hmr(开发环境热更新)时也会执行<code>queueJob</code></p></li></ul><h4 id="queuePostFlushCb"><a href="#queuePostFlushCb" class="headerlink" title="queuePostFlushCb"></a>queuePostFlushCb</h4><p>  在Job进入<code>queuePostFlushCb</code>时也会进行判断，此时判断的是任务是否在<code>activePostFlushCbs</code>队列中，即是否将要执行，如果不存在即将执行的任务队列则添加到<code>pendingPostFlushCbs</code>队列</p><ul><li><p>在组件的mount、update、unmount等生命周期时都会执行<code>queuePostFlushCb</code>添加后置任务</p><blockquote><p>点太多了，都粘过来有点多余了，具体详见源码: packages/runtime-core/src/renderer.ts</p></blockquote></li><li><p>在<code>Suspense</code>组件中父组件全部加载完之后</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/runtime-core/src/components/Suspense.ts</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="comment">// flush buffered effects</span></span><br><span class="line"><span class="comment">// check if there is a pending parent suspense</span></span><br><span class="line"><span class="keyword">let</span> parent = suspense.<span class="property">parent</span></span><br><span class="line"><span class="keyword">let</span> hasUnresolvedAncestor = <span class="literal">false</span></span><br><span class="line"><span class="keyword">while</span> (parent) &#123;</span><br><span class="line">  <span class="keyword">if</span> (parent.<span class="property">pendingBranch</span>) &#123;</span><br><span class="line">    <span class="comment">// found a pending parent suspense, merge buffered post jobs</span></span><br><span class="line">    <span class="comment">// into that parent</span></span><br><span class="line">    parent.<span class="property">effects</span>.<span class="title function_">push</span>(...effects)</span><br><span class="line">    hasUnresolvedAncestor = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">break</span></span><br><span class="line">  &#125;</span><br><span class="line">  parent = parent.<span class="property">parent</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// no pending parent suspense, flush all jobs</span></span><br><span class="line"><span class="keyword">if</span> (!hasUnresolvedAncestor) &#123;</span><br><span class="line">  <span class="title function_">queuePostFlushCb</span>(effects)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>hmr(热更新之后)</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/runtime-core/src/hmr.ts</span></span><br><span class="line"><span class="comment">// 5. make sure to cleanup dirty hmr components after update</span></span><br><span class="line"><span class="title function_">queuePostFlushCb</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> instance <span class="keyword">of</span> instances) &#123;</span><br><span class="line">    hmrDirtyComponents.<span class="title function_">delete</span>(</span><br><span class="line">      <span class="title function_">normalizeClassComponent</span>(instance.<span class="property">type</span> <span class="keyword">as</span> <span class="title class_">HMRComponent</span>)</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li></ul><blockquote><p>ssr 相关的没列</p></blockquote><h3 id="任务优先级"><a href="#任务优先级" class="headerlink" title="任务优先级"></a>任务优先级</h3><p>Vue中的<code>scheduler</code>通过comparator给<code>queue</code>队列中的<code>pre任务</code>和<code>普通任务</code>进行排序，而<code>pendingPostFlushCbs</code>队列则存放<code>post任务</code>一定在<code>queue</code>队列执行之后才会执行</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/runtime-core/src/scheduler.ts</span></span><br><span class="line"><span class="keyword">const</span> comparator = (<span class="attr">a</span>: <span class="title class_">SchedulerJob</span>, <span class="attr">b</span>: <span class="title class_">SchedulerJob</span>): <span class="function"><span class="params">number</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> diff = <span class="title function_">getId</span>(a) - <span class="title function_">getId</span>(b)</span><br><span class="line">  <span class="comment">// 如果id相同根据是否是pre进行排序，pre优先于普通任务， 如果id不同则根据从小到大排序，确保parent的任务优于children的任务执行</span></span><br><span class="line">  <span class="keyword">if</span> (diff === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (a.<span class="property">pre</span> &amp;&amp; !b.<span class="property">pre</span>) <span class="keyword">return</span> -<span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> (b.<span class="property">pre</span> &amp;&amp; !a.<span class="property">pre</span>) <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> diff</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  flowchart LR  a(pre Job1) --&gt; a2(Job1) --&gt; a3(Job2) --&gt; a4(post Job1)  </pre></div><h3 id="任务执行分析"><a href="#任务执行分析" class="headerlink" title="任务执行分析"></a>任务执行分析</h3><p>任务通过以下三个函数执行：</p><h4 id="flushJobs"><a href="#flushJobs" class="headerlink" title="flushJobs"></a>flushJobs</h4><p>  这个函数最初由<code>queueJob</code>开始触发执行<code>queueFlush</code>，包装一层<code>Promise.resolve</code>后执行<code>flushJobs</code></p><blockquote><p>此处主要分析<code>flushJobs</code>函数，其余源码请看：packages/runtime-core/src/scheduler.ts</p></blockquote>  <figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">flushJobs</span>(<span class="params">seen?: CountMap</span>) &#123;</span><br><span class="line">  <span class="comment">// 设置任务状态为Flushing（已完成）</span></span><br><span class="line">  isFlushPending = <span class="literal">false</span></span><br><span class="line">  isFlushing = <span class="literal">true</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  queue.<span class="title function_">sort</span>(comparator)</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 此处按优先级执行任务Job</span></span><br><span class="line">    <span class="keyword">for</span> (flushIndex = <span class="number">0</span>; flushIndex &lt; queue.<span class="property">length</span>; flushIndex++) &#123;</span><br><span class="line">      <span class="keyword">const</span> job = queue[flushIndex]</span><br><span class="line">      <span class="comment">// 判断Job是否失活，比如任务执行前卸载了组件，就会跳过这个任务</span></span><br><span class="line">      <span class="keyword">if</span> (job &amp;&amp; job.<span class="property">active</span> !== <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="comment">// 由统一的错误处理程序执行job，可以统一报错</span></span><br><span class="line">        <span class="comment">// 具体声明详见： packages/runtime-core/src/errorHandling.ts</span></span><br><span class="line">        <span class="title function_">callWithErrorHandling</span>(job, <span class="literal">null</span>, <span class="title class_">ErrorCodes</span>.<span class="property">SCHEDULER</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="comment">// 将标志及队列初始化</span></span><br><span class="line">    flushIndex = <span class="number">0</span></span><br><span class="line">    queue.<span class="property">length</span> = <span class="number">0</span></span><br><span class="line">    <span class="comment">// 执行后置任务</span></span><br><span class="line">    <span class="title function_">flushPostFlushCbs</span>(seen)</span><br><span class="line">    <span class="comment">// 初始化任务状态及任务当前的Promise</span></span><br><span class="line">    isFlushing = <span class="literal">false</span></span><br><span class="line">    currentFlushPromise = <span class="literal">null</span></span><br><span class="line">    <span class="comment">// 如果queue或pendingPostFlushCbs中还存在任务则递归调用当前函数</span></span><br><span class="line">    <span class="keyword">if</span> (queue.<span class="property">length</span> || pendingPostFlushCbs.<span class="property">length</span>) &#123;</span><br><span class="line">      <span class="title function_">flushJobs</span>(seen)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="flushPreFlushCbs"><a href="#flushPreFlushCbs" class="headerlink" title="flushPreFlushCbs"></a>flushPreFlushCbs</h4><blockquote><p>这个函数只会在组件render和updateComponentPreRender时才会执行</p></blockquote>  <figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">flushPreFlushCbs</span>(<span class="params"></span></span><br><span class="line"><span class="params">  seen?: CountMap,</span></span><br><span class="line"><span class="params">  <span class="comment">// if currently flushing, skip the current job itself</span></span></span><br><span class="line"><span class="params">  i = isFlushing ? flushIndex + <span class="number">1</span> : <span class="number">0</span></span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// 从标识位开始执行，标识位之前的是已经执行过的</span></span><br><span class="line">  <span class="keyword">for</span> (; i &lt; queue.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> cb = queue[i]</span><br><span class="line">    <span class="comment">// 如果pre属性存在则为前置任务，执行完删除，同时标志位向前挪一位（不挪会导致少执行一个任务）</span></span><br><span class="line">    <span class="keyword">if</span> (cb &amp;&amp; cb.<span class="property">pre</span>) &#123;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">      queue.<span class="title function_">splice</span>(i, <span class="number">1</span>)</span><br><span class="line">      i--</span><br><span class="line">      <span class="title function_">cb</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="flushPostFlushCbs"><a href="#flushPostFlushCbs" class="headerlink" title="flushPostFlushCbs"></a>flushPostFlushCbs</h4><p>  这个函数会执行后置任务即<code>post任务</code>，除在<code>flushJobs</code>中执行完<code>queue</code>队列后执行外，在组件render阶段也会被执行</p>  <figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">flushPostFlushCbs</span>(<span class="params">seen?: CountMap</span>) &#123;</span><br><span class="line">  <span class="comment">// 判断post任务的队列是否有任务</span></span><br><span class="line">  <span class="keyword">if</span> (pendingPostFlushCbs.<span class="property">length</span>) &#123;</span><br><span class="line">    <span class="comment">// 进行去重，同时清空post队列</span></span><br><span class="line">    <span class="keyword">const</span> deduped = [...<span class="keyword">new</span> <span class="title class_">Set</span>(pendingPostFlushCbs)]</span><br><span class="line">    pendingPostFlushCbs.<span class="property">length</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断是否存在正在执行的后置任务队列即activePostFlushCbs队列，存在则直接加到队列后边</span></span><br><span class="line">    <span class="keyword">if</span> (activePostFlushCbs) &#123;</span><br><span class="line">      activePostFlushCbs.<span class="title function_">push</span>(...deduped)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将pendingPostFlushCbs队列内的任务去重后赋值给正在执行的队列activePostFlushCbs队列</span></span><br><span class="line">    activePostFlushCbs = deduped</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 根据id排序，确保parent任务优先执行</span></span><br><span class="line">    activePostFlushCbs.<span class="title function_">sort</span>(<span class="function">(<span class="params">a, b</span>) =&gt;</span> <span class="title function_">getId</span>(a) - <span class="title function_">getId</span>(b))</span><br><span class="line">    <span class="comment">// 按顺序执行任务</span></span><br><span class="line">    <span class="keyword">for</span> (</span><br><span class="line">      postFlushIndex = <span class="number">0</span>;</span><br><span class="line">      postFlushIndex &lt; activePostFlushCbs.<span class="property">length</span>;</span><br><span class="line">      postFlushIndex++</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="comment">// ... </span></span><br><span class="line">      activePostFlushCbs[postFlushIndex]()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 初始化正在执行的后置任务队列activePostFlushCbs</span></span><br><span class="line">    <span class="comment">// 初始化后置任务标志位</span></span><br><span class="line">    activePostFlushCbs = <span class="literal">null</span></span><br><span class="line">    postFlushIndex = <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="nextTick"><a href="#nextTick" class="headerlink" title="nextTick"></a>nextTick</h3><p>作为Vue中的一个全局API，它的作用是等待下一次 DOM 更新刷新的工具方法.</p><blockquote><p>API介绍： <a href="https://cn.vuejs.org/api/general.html#nexttick">https://cn.vuejs.org/api/general.html#nexttick</a></p></blockquote><p>它同样写在了<code>packages/runtime-core/src/scheduler.ts</code>文件中，它是通过什么才能确保在下一次更新时才执行回调的呢，是不是有这个疑问，下面就是它的源码：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> nextTick&lt;T = <span class="built_in">void</span>, R = <span class="built_in">void</span>&gt;(</span><br><span class="line">  <span class="attr">this</span>: T,</span><br><span class="line">  fn?: <span class="function">(<span class="params"><span class="variable language_">this</span>: T</span>) =&gt;</span> R</span><br><span class="line">): <span class="title class_">Promise</span>&lt;<span class="title class_">Awaited</span>&lt;R&gt;&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> p = currentFlushPromise || resolvedPromise</span><br><span class="line">  <span class="keyword">return</span> fn ? p.<span class="title function_">then</span>(<span class="variable language_">this</span> ? fn.<span class="title function_">bind</span>(<span class="variable language_">this</span>) : fn) : p</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>它就是在任务调度系统中维护的那个<code>currentFlushPromise</code>当前任务的Promise之后加了个.then的微任务，由于任务队列中的任务都会在currentFlushPromise的第一个.then中执行，所以nextTick才能在那些任务之后执行。</p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>scheduler的作用就是接收其他的函数丢过来的任务，然后把他们执行掉</p><p>别人只管丢任务给总部，不用管任务什么时候做，就好比我们的排期，产品只管丢给actionView，actionView会安排任务什么时候执行。。</p>]]></content>
      
      
      <categories>
          
          <category> Vue </category>
          
          <category> Scheduler </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Vue </tag>
            
            <tag> 源码分析 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>基于element select多分组多级下拉筛选封装</title>
      <link href="/2023/07/18/%E5%9F%BA%E4%BA%8Eelement-select%E5%A4%9A%E5%88%86%E7%BB%84%E5%A4%9A%E7%BA%A7%E4%B8%8B%E6%8B%89%E7%AD%9B%E9%80%89%E5%B0%81%E8%A3%85/"/>
      <url>/2023/07/18/%E5%9F%BA%E4%BA%8Eelement-select%E5%A4%9A%E5%88%86%E7%BB%84%E5%A4%9A%E7%BA%A7%E4%B8%8B%E6%8B%89%E7%AD%9B%E9%80%89%E5%B0%81%E8%A3%85/</url>
      
        <content type="html"><![CDATA[<h2 id="基于element-select多分组多级下拉筛选封装"><a href="#基于element-select多分组多级下拉筛选封装" class="headerlink" title="基于element select多分组多级下拉筛选封装"></a>基于element select多分组多级下拉筛选封装</h2><h3 id="实现效果"><a href="#实现效果" class="headerlink" title="实现效果"></a>实现效果</h3><p><img src="https://cdn.chrelyonly.cf/gh/011-01-10-110/static_resources@master/1689644065468.jpg" alt="示例"></p><h3 id="具体需求"><a href="#具体需求" class="headerlink" title="具体需求"></a>具体需求</h3><ul><li>这是个多选下拉组件</li><li>组件内包含有<code>分组</code>（<code>分组</code>不可点击）</li><li><code>分组</code>下有<code>二级分类</code></li><li>点击<code>一级分类</code>，选中该分类下所有<code>二级分类</code></li></ul><p>乍一看是挺容易的需求，正当我也以为如此时，转折发生了</p><h3 id="难点出现"><a href="#难点出现" class="headerlink" title="难点出现"></a>难点出现</h3><p>下拉框的源数据结构事例如下：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    &#x27;code&#x27;<span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">    &#x27;desc&#x27;<span class="punctuation">:</span> &#x27;分组<span class="number">1</span>&#x27;<span class="punctuation">,</span></span><br><span class="line">    &#x27;children&#x27;<span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        &#x27;code&#x27;<span class="punctuation">:</span> <span class="number">1010</span><span class="punctuation">,</span></span><br><span class="line">        &#x27;desc&#x27;<span class="punctuation">:</span> &#x27;类型一级&#x27;<span class="punctuation">,</span></span><br><span class="line">        &#x27;sub_type&#x27;<span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            &#x27;code&#x27;<span class="punctuation">:</span> <span class="number">1020</span><span class="punctuation">,</span></span><br><span class="line">            &#x27;desc&#x27;<span class="punctuation">:</span> &#x27;类型二级<span class="number">1</span>&#x27;</span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        &#x27;code&#x27;<span class="punctuation">:</span> <span class="number">1011</span><span class="punctuation">,</span></span><br><span class="line">        &#x27;desc&#x27;<span class="punctuation">:</span> &#x27;类型一级<span class="number">2</span>&#x27;<span class="punctuation">,</span></span><br><span class="line">        &#x27;sub_type&#x27;<span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    &#x27;code&#x27;<span class="punctuation">:</span> <span class="number">20</span><span class="punctuation">,</span></span><br><span class="line">    &#x27;desc&#x27;<span class="punctuation">:</span> &#x27;分组<span class="number">2</span>&#x27;<span class="punctuation">,</span></span><br><span class="line">    &#x27;children&#x27;<span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        &#x27;code&#x27;<span class="punctuation">:</span> <span class="number">2010</span><span class="punctuation">,</span></span><br><span class="line">        &#x27;desc&#x27;<span class="punctuation">:</span> &#x27;类型一级&#x27;<span class="punctuation">,</span></span><br><span class="line">        &#x27;sub_type&#x27;<span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            &#x27;code&#x27;<span class="punctuation">:</span> <span class="number">1020</span><span class="punctuation">,</span></span><br><span class="line">            &#x27;desc&#x27;<span class="punctuation">:</span> &#x27;类型二级<span class="number">1</span>&#x27;</span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        &#x27;code&#x27;<span class="punctuation">:</span> <span class="number">2011</span><span class="punctuation">,</span></span><br><span class="line">        &#x27;desc&#x27;<span class="punctuation">:</span> &#x27;类型一级<span class="number">2</span>&#x27;<span class="punctuation">,</span></span><br><span class="line">        &#x27;sub_type&#x27;<span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure><p>看了数据好像也没有感觉出来难在哪，仔细观摩，数据从children开始为<code>分组</code>下的<code>二级分类</code>数据，分为一级和二级，问题点：</p><ul><li><p>一级类型的code不会重复，但是仔细观察发现他居然有可能没有<code>二级分类</code>，这还选个毛啊，实际需求隐式包含了几条规则</p><ul><li>单独一级是可以选的</li><li>有二级的<code>一级分类</code>是不可以单独选中的</li></ul></li><li><p>不同<code>一级分类</code>下的<code>二级分类</code>code是有重复</p></li><li><p>由于上面说的code会重复，所以最后确定后端要的数据结构是个Object类型，如：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> data = &#123;</span><br><span class="line">  <span class="number">1010</span>: [<span class="number">1020</span>], <span class="comment">// 有二级并且选了的就是key是一级code，value是二级数组</span></span><br><span class="line">  <span class="number">1010</span>: [] <span class="comment">// 没有二级只选了一级，value是个空数组</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>而我们熟知的select多选的数据结构都是Array类</p></li></ul><h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><p>了解了需求分析了问题，终于到了该解决问题的时候了，俗话说有困难就解决困难，解决不掉就等着被解决就行了，人和代码有一个能跑就行了</p><h4 id="模版的设计"><a href="#模版的设计" class="headerlink" title="模版的设计"></a>模版的设计</h4><p>如果我们按element的select分组的结构写的话就不可避免的涉及到几个问题：</p><ul><li><code>分组</code>是不可选的</li><li>如果<code>一级分类</code>作为分组，那么如果所有<code>一级分类</code>都没有<code>二级分类</code>，分组会直接不展示，也就是下拉框会变为空的</li><li><code>一级分类</code>是可以单独选择的</li></ul><p>就这几个问题而言，使用默认的select组件带的分组是行不通了</p><p>为了满足以下条件：</p><ul><li><code>分组</code>不可点</li><li>没有<code>二级分类</code>的<code>一级分类</code>可单独选</li><li>有<code>二级分类</code>的<code>一级分类</code>点了就选择当前分类下所有<code>二级分类</code></li></ul><p>思考结构的时候太复杂的结构更不利于维护，尽量往简单了想，索性全部用el-option来处理吧，把多级的结构扁平化直接就一层还好理解，具体实现：</p><ul><li><code>分组</code>可以直接用<code>disabled+class</code>控制不可选就完事了</li><li><code>一级分类</code>分为两种情况：<ul><li>一种是包含<code>二级分类</code>的这个时候<code>一级分类</code>不能单独选中就用<code>div+class模拟</code>稍小一点的option做个区分</li><li>另一种呢是不存在<code>二级分类</code>的<code>一级分类</code>，这个时候它可以单独选中，就用option来实现就行了</li></ul></li><li>二级分类就简单了直接遍历sub_type渲染option就行了</li></ul><p>具体代码：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">el-select</span> <span class="attr">v-model</span>=<span class="string">&quot;selectValue&quot;</span> <span class="attr">:placeholder</span>=<span class="string">&quot;props.placeholder || &#x27;请选择&#x27;&quot;</span> <span class="attr">multiple</span> <span class="attr">clearable</span> <span class="attr">:disabled</span>=<span class="string">&quot;props.disabled&quot;</span> @<span class="attr">change</span>=<span class="string">&quot;handleChange&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">template</span> <span class="attr">v-for</span>=<span class="string">&quot;group in RELATETYPELIST&quot;</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- 分组 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">el-option</span> <span class="attr">class</span>=<span class="string">&quot;el-select-group__title group&quot;</span> <span class="attr">:key</span>=<span class="string">&quot;group.code&quot;</span> <span class="attr">v-if</span>=<span class="string">&quot;group.isTitle&quot;</span> <span class="attr">:label</span>=<span class="string">&quot;`$&#123;group.desc&#125;`&quot;</span> <span class="attr">:value</span>=<span class="string">&quot;group.code&quot;</span> <span class="attr">disabled</span>&gt;</span>&#123;&#123; group.desc &#125;&#125;<span class="tag">&lt;/<span class="name">el-option</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">template</span> <span class="attr">v-else</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 两级，这个充当一级 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span></span></span><br><span class="line"><span class="tag">          <span class="attr">v-if</span>=<span class="string">&quot;group.sub_type &amp;&amp; !!group.sub_type.length&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">:key</span>=<span class="string">&quot;group.code&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">&quot;el-select-group__title group can-select&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">:class</span>=<span class="string">&quot;&#123; &#x27;all-selected&#x27;: groupStatus[group.code] &#125;&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">:label</span>=<span class="string">&quot;`$&#123;group.desc&#125;`&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">:value</span>=<span class="string">&quot;group.code&quot;</span></span></span><br><span class="line"><span class="tag">          @<span class="attr">click</span>=<span class="string">&quot;handleClickGroup(group)&quot;</span></span></span><br><span class="line"><span class="tag">        &gt;</span>&#123;&#123; group.desc &#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 只有一级的时候 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">el-option</span> <span class="attr">v-else</span> <span class="attr">class</span>=<span class="string">&quot;group can-select&quot;</span> <span class="attr">:key</span>=<span class="string">&quot;group.code&quot;</span> <span class="attr">:label</span>=<span class="string">&quot;`$&#123;group.desc&#125;`&quot;</span> <span class="attr">:value</span>=<span class="string">&quot;group.code&quot;</span>&gt;</span>&#123;&#123; group.desc &#125;&#125;<span class="tag">&lt;/<span class="name">el-option</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 二级分类 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">el-option</span> <span class="attr">class</span>=<span class="string">&quot;pl-30&quot;</span> <span class="attr">v-for</span>=<span class="string">&quot;item in group.sub_type&quot;</span> <span class="attr">:key</span>=<span class="string">&quot;item.code&quot;</span> <span class="attr">:label</span>=<span class="string">&quot;`$&#123;group.desc&#125;-$&#123;item.desc&#125;`&quot;</span> <span class="attr">:value</span>=<span class="string">&quot;item.code&quot;</span>&gt;</span></span><br><span class="line">          &#123;&#123;item.desc&#125;&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">el-option</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">el-select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="处理源数据"><a href="#处理源数据" class="headerlink" title="处理源数据"></a>处理源数据</h4><p>首先我们确定了后端给我们的数据结构是如下结构：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">BaseData</span> &#123;</span><br><span class="line">  <span class="attr">code</span>: <span class="built_in">number</span></span><br><span class="line">  <span class="attr">desc</span>: <span class="built_in">string</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">LvData</span> <span class="keyword">extends</span> <span class="title class_">BaseData</span> &#123;</span><br><span class="line">  <span class="attr">sub_type</span>: <span class="title class_">BaseData</span>[]</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">GroupData</span> <span class="keyword">extends</span> <span class="title class_">BaseData</span> &#123;</span><br><span class="line">  <span class="attr">children</span>: <span class="title class_">LvData</span>[]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>根据我们想到的<code>template</code>结构，目前这个结构三级嵌套我们没法直接用</p><p>为了达到我们这个尽可能简单的实现的目的来分析这个结构：</p><ul><li>首先<code>分组</code>这一层本来就不能选，而且我们把它扁平化了，起码要与<code>一级分类</code>同级</li><li><code>二级分类</code>总要被遍历的，所以拆开它弊大于利</li></ul><p>所以最终的结构如下:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="variable constant_">RELATETYPELIST</span> = [</span><br><span class="line">  &#123; <span class="attr">code</span>: <span class="number">10</span>, <span class="attr">desc</span>: <span class="string">&#x27;分组1&#x27;</span>, <span class="attr">isTitle</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">code</span>: <span class="number">1010</span>, <span class="attr">desc</span>: <span class="string">&#x27;类型一级&#x27;</span>， <span class="attr">sub_type</span>: [] &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h5 id="RELATETYPELIST处理"><a href="#RELATETYPELIST处理" class="headerlink" title="RELATETYPELIST处理"></a>RELATETYPELIST处理</h5><p>为了实现点击<code>一级分类</code>快速找到对应的<code>二级分类</code>，并且选中我们还需要一份数据，此处我选择<code>Map类型</code>的数据，好处在于Object类型的数据如果用code做key会被重新排序，为了偷懒（少处理一次数据）,所以在处理渲染数组<code>RELATETYPELIST</code>之前直接造出<code>Map</code>,然后取<code>Map</code>的value就行了，毕竟<code>Map</code>的顺序不会被重排</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 下拉框渲染options的源数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">localListToMap</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> localList = [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&#x27;code&#x27;</span>: <span class="number">10</span>,</span><br><span class="line">      <span class="string">&#x27;desc&#x27;</span>: <span class="string">&#x27;分组1&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;children&#x27;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&#x27;code&#x27;</span>: <span class="number">1010</span>,</span><br><span class="line">          <span class="string">&#x27;desc&#x27;</span>: <span class="string">&#x27;类型一级&#x27;</span>,</span><br><span class="line">          <span class="string">&#x27;sub_type&#x27;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="string">&#x27;code&#x27;</span>: <span class="number">1020</span>,</span><br><span class="line">              <span class="string">&#x27;desc&#x27;</span>: <span class="string">&#x27;类型二级1&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">          ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&#x27;code&#x27;</span>: <span class="number">1011</span>,</span><br><span class="line">          <span class="string">&#x27;desc&#x27;</span>: <span class="string">&#x27;类型一级2&#x27;</span>,</span><br><span class="line">          <span class="string">&#x27;sub_type&#x27;</span>: []</span><br><span class="line">        &#125;,</span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&#x27;code&#x27;</span>: <span class="number">20</span>,</span><br><span class="line">      <span class="string">&#x27;desc&#x27;</span>: <span class="string">&#x27;分组2&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;children&#x27;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&#x27;code&#x27;</span>: <span class="number">2010</span>,</span><br><span class="line">          <span class="string">&#x27;desc&#x27;</span>: <span class="string">&#x27;类型一级&#x27;</span>,</span><br><span class="line">          <span class="string">&#x27;sub_type&#x27;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="string">&#x27;code&#x27;</span>: <span class="number">1020</span>,</span><br><span class="line">              <span class="string">&#x27;desc&#x27;</span>: <span class="string">&#x27;类型二级1&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">          ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&#x27;code&#x27;</span>: <span class="number">2011</span>,</span><br><span class="line">          <span class="string">&#x27;desc&#x27;</span>: <span class="string">&#x27;类型一级2&#x27;</span>,</span><br><span class="line">          <span class="string">&#x27;sub_type&#x27;</span>: []</span><br><span class="line">        &#125;,</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">  <span class="keyword">const</span> localListMap = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">  <span class="comment">// 把最外层的分组跟第一级类型摊平</span></span><br><span class="line">  localList.<span class="title function_">forEach</span>(<span class="function">(<span class="params">parent</span>) =&gt;</span> &#123;</span><br><span class="line">    localListMap.<span class="title function_">set</span>(<span class="string">`<span class="subst">$&#123;parent.code&#125;</span>`</span>, &#123; <span class="attr">code</span>: <span class="string">`<span class="subst">$&#123;parent.code&#125;</span>`</span>, <span class="attr">desc</span>: parent.<span class="property">desc</span>, <span class="attr">isTitle</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">    parent.<span class="property">children</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">d</span> =&gt;</span> &#123;</span><br><span class="line">      localListMap.<span class="title function_">set</span>(<span class="string">`<span class="subst">$&#123;d.code&#125;</span>`</span>, &#123; ...d, <span class="attr">code</span>: <span class="string">`<span class="subst">$&#123;d.code&#125;</span>`</span>, <span class="attr">sub_type</span>: d.<span class="property">sub_type</span>?.<span class="title function_">map</span>(<span class="function"><span class="params">child</span> =&gt;</span> (&#123; ...child, <span class="attr">code</span>: <span class="string">`<span class="subst">$&#123;d.code&#125;</span>.<span class="subst">$&#123;child.code&#125;</span>`</span> &#125;)) &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">// 根据一级code和分组code 组成Map</span></span><br><span class="line">  <span class="keyword">return</span> localListMap</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Map(6) &#123;&#x27;10&#x27; =&gt; &#123;…&#125;, &#x27;1010&#x27; =&gt; &#123;…&#125;, &#x27;1011&#x27; =&gt; &#123;…&#125;, &#x27;20&#x27; =&gt; &#123;…&#125;, &#x27;2010&#x27; =&gt; &#123;…&#125;, …&#125;</span></span><br><span class="line"><span class="comment">// &#123;</span></span><br><span class="line"><span class="comment">//     &quot;key&quot;: &quot;10&quot;,</span></span><br><span class="line"><span class="comment">//     &quot;value&quot;: &#123;</span></span><br><span class="line"><span class="comment">//         &quot;code&quot;: &quot;10&quot;,</span></span><br><span class="line"><span class="comment">//         &quot;desc&quot;: &quot;分组1&quot;,</span></span><br><span class="line"><span class="comment">//         &quot;isTitle&quot;: true</span></span><br><span class="line"><span class="comment">//     &#125;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="comment">// &#123;</span></span><br><span class="line"><span class="comment">//     &quot;key&quot;: &quot;1010&quot;,</span></span><br><span class="line"><span class="comment">//     &quot;value&quot;: &#123;</span></span><br><span class="line"><span class="comment">//         &quot;code&quot;: &quot;1010&quot;,</span></span><br><span class="line"><span class="comment">//         &quot;desc&quot;: &quot;类型一级&quot;,</span></span><br><span class="line"><span class="comment">//         &quot;sub_type&quot;: [</span></span><br><span class="line"><span class="comment">//             &#123;</span></span><br><span class="line"><span class="comment">//                 &quot;code&quot;: &quot;1010.1020&quot;,</span></span><br><span class="line"><span class="comment">//                 &quot;desc&quot;: &quot;类型二级1&quot;</span></span><br><span class="line"><span class="comment">//             &#125;</span></span><br><span class="line"><span class="comment">//         ]</span></span><br><span class="line"><span class="comment">//     &#125;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br></pre></td></tr></table></figure><h5 id="一级类型选中状态处理"><a href="#一级类型选中状态处理" class="headerlink" title="一级类型选中状态处理"></a>一级类型选中状态处理</h5><p>除此之外我们还需要考虑div做<code>一级分类</code>的时候如何准确的加上class，当然在处理<code>Map</code>的时候加上属性控制也可以，但是这样又会让结构变得不再纯粹，所以我使用一个新的对象存状态，这个时候就不需要考虑顺序问题了，只需要存<code>一级类型</code>的code和一个<code>Boolean</code>值就可以了，所以结构如下:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> groupStatus = &#123;</span><br><span class="line">  <span class="number">1010</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="双向绑定的值处理"><a href="#双向绑定的值处理" class="headerlink" title="双向绑定的值处理"></a>双向绑定的值处理</h5><p>下拉框的渲染和一级分类选中的问题解决了，我么该考虑下select组件<code>v-model</code>的数据怎么处理了，这里我才用<code>computed</code>来作为绑定值，具体为啥用<code>computed</code>可以实现看官网吧，下面分析如何写getter和setter：</p><ul><li>输入和输出需要保持数据结构一致</li><li>为了满足后端的要求，我们需要将<code>emit</code>的输出处理成<code>对象</code></li><li>为了满足element组件的要求，我们还需要对getter的输出处理为<code>数组</code></li></ul><p>如下为具体实现:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * select 组件内部绑定的value的getter函数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">&#123;[key as Stirng]: Array</span>&#125;&#125; value 外部传入的双向绑定对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@example</span></span></span><br><span class="line"><span class="comment"> * // value demo</span></span><br><span class="line"><span class="comment"> * const value = &#123;</span></span><br><span class="line"><span class="comment"> *  1010: [1101, 1102, 1103]</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> * const val = getValue(value) // [&#x27;1010.1101&#x27;, &#x27;1010.1102&#x27;, &#x27;1010.1103&#x27;]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">getValue</span> = (<span class="params">value = &#123;&#125;</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> v = []</span><br><span class="line">  <span class="comment">// 将对象转为数组进行处理</span></span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">entries</span>(value).<span class="title function_">forEach</span>(<span class="function">(<span class="params">[key, subVal]</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 如果存在二级分类则便利二级分类处理为以 . 链接的字符串满足option的对应关系</span></span><br><span class="line">    <span class="keyword">if</span> (subVal.<span class="property">length</span>) &#123;</span><br><span class="line">      subVal.<span class="title function_">forEach</span>(<span class="function">(<span class="params">val</span>) =&gt;</span> &#123;</span><br><span class="line">        v.<span class="title function_">push</span>(<span class="string">`<span class="subst">$&#123;key&#125;</span>.<span class="subst">$&#123;val&#125;</span>`</span>)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 否则直接加进去，为不包含二级分类只有一级分类的option</span></span><br><span class="line">      v.<span class="title function_">push</span>(<span class="string">`<span class="subst">$&#123;key&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> v</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 响应式返回给上一层的数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Array&lt;String&gt;</span>&#125; <span class="variable">value</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> &#123;<span class="type">&#123;[key as String]: Array</span>&#125;&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">setValue</span> = (<span class="params">value</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> vMap = <span class="keyword">new</span> <span class="title class_">Map</span>() <span class="comment">// 这里也可以直接用一个空对象进行添加</span></span><br><span class="line">  value.<span class="title function_">forEach</span>(<span class="function">(<span class="params">val</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 将已选的数据每项用 . 拆开表示一级code和二级code</span></span><br><span class="line">    <span class="keyword">const</span> [key, subVal] = val.<span class="title function_">split</span>(<span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">    <span class="comment">// 判断是否存在这个一级code作为key的值，如果vMap用对象的话可以使用hasOwnProperty判断</span></span><br><span class="line">    <span class="keyword">if</span> (!vMap.<span class="title function_">has</span>(key)) &#123;</span><br><span class="line">      vMap.<span class="title function_">set</span>(key, [])</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果存在二级code则加入数组里</span></span><br><span class="line">    <span class="keyword">if</span> (subVal) &#123;</span><br><span class="line">      vMap.<span class="title function_">get</span>(key).<span class="title function_">push</span>(subVal)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">// 如果没选中任何值则然后undefined</span></span><br><span class="line">  <span class="keyword">if</span> (!vMap.<span class="property">size</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">undefined</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 返回一个对象，如&#123; 1010: [1020] &#125;</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Object</span>.<span class="title function_">fromEntries</span>([...vMap.<span class="title function_">entries</span>()])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 双向绑定的处理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> selectValue = <span class="title function_">computed</span>(&#123;</span><br><span class="line">  <span class="attr">get</span>: <span class="function">() =&gt;</span> <span class="title function_">getValue</span>(props.<span class="property">value</span>),</span><br><span class="line">  <span class="attr">set</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> v = <span class="title function_">setValue</span>(value)</span><br><span class="line">    <span class="title function_">emit</span>(<span class="string">&#x27;update:value&#x27;</span>, v)</span><br><span class="line">    <span class="title function_">emit</span>(<span class="string">&#x27;changeSelect&#x27;</span>, v)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><blockquote><p>v-model的处理: <a href="https://cn.vuejs.org/guide/components/v-model.html">https://cn.vuejs.org/guide/components/v-model.html</a></p></blockquote><h4 id="事件处理"><a href="#事件处理" class="headerlink" title="事件处理"></a>事件处理</h4><p>至此我们解决了页面渲染的问题</p><p>我们已有的数据如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">useSelectData</span> = (<span class="params">props, emit</span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// map结构，一级code做key</span></span><br><span class="line">  <span class="keyword">const</span> <span class="variable constant_">RELATETYPELISTMAP</span> = <span class="title function_">localListToMap</span>()</span><br><span class="line">  <span class="comment">// 所有一级对应的数据，包含二级数据</span></span><br><span class="line">  <span class="keyword">const</span> <span class="variable constant_">RELATETYPELIST</span> = [...<span class="variable constant_">RELATETYPELISTMAP</span>.<span class="title function_">values</span>()]</span><br><span class="line">  <span class="comment">// 所有一级分组的选中态， filter过滤掉最外层只展示的分组</span></span><br><span class="line">  <span class="keyword">const</span> groupStatus = <span class="title function_">reactive</span>(</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">fromEntries</span>([...<span class="variable constant_">RELATETYPELISTMAP</span>.<span class="title function_">entries</span>()]</span><br><span class="line">      .<span class="title function_">filter</span>(<span class="function">(<span class="params">[key, val]</span>) =&gt;</span> !val.<span class="property">isTitle</span>)</span><br><span class="line">      .<span class="title function_">map</span>(<span class="function">(<span class="params">[key, val]</span>) =&gt;</span> [key, <span class="literal">false</span>]))</span><br><span class="line">  )</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 双向绑定的处理</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">const</span> selectValue = <span class="title function_">computed</span>(&#123;</span><br><span class="line">    <span class="attr">get</span>: <span class="function">() =&gt;</span> <span class="title function_">getValue</span>(props.<span class="property">value</span>),</span><br><span class="line">    <span class="attr">set</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> v = <span class="title function_">setValue</span>(value)</span><br><span class="line">      <span class="title function_">emit</span>(<span class="string">&#x27;update:value&#x27;</span>, v)</span><br><span class="line">      <span class="title function_">emit</span>(<span class="string">&#x27;changeRelateType&#x27;</span>, v)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="variable constant_">RELATETYPELIST</span>,</span><br><span class="line">    groupStatus,</span><br><span class="line">    selectValue</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们还需要解决的问题是：</p><ul><li>点击<code>二级分类</code>时判断<code>一级分类</code>是否被选中</li><li>点击<code>一级分类</code>时选中所有当前<code>一级分类下</code>的所有<code>二级分类</code></li></ul><h5 id="处理正常点击option"><a href="#处理正常点击option" class="headerlink" title="处理正常点击option"></a>处理正常点击option</h5><p>处理二级分类点击时一级分类是否选中，我们可以直接监听select组件的change事件，具体思路如下：</p><ul><li>当清空select时传入的value会是一个空数组，这个时候把所有的<code>一级分类</code>选中状态的对象都赋值为false</li><li>当选择了某个option时，把已选的数据处理成一个<code>Map</code>或者<code>Object</code>，这样对比源数据和已选数据比较容易，直接比对code一致的<code>一级分类</code>下的<code>二级分类</code>数量就行了，一致的就是全选，此时<code>一级分类</code>变色，不一致就不变</li></ul><p>如下是代码实现：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 选项改变时</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">handleChange</span> = (<span class="params">value</span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 如果清空选项把group的选中态清空</span></span><br><span class="line">  <span class="keyword">if</span> (!value.<span class="property">length</span>) &#123;</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">keys</span>(groupStatus).<span class="title function_">forEach</span>(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">      groupStatus[key] = <span class="literal">false</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> selectedMap = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">  <span class="comment">// 将已选项处理成一个Map</span></span><br><span class="line">  value.<span class="title function_">forEach</span>(<span class="function">(<span class="params">v</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> [key, val] = v.<span class="title function_">split</span>(<span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> (!selectedMap.<span class="title function_">has</span>(key)) &#123;</span><br><span class="line">      selectedMap.<span class="title function_">set</span>(key, [])</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (val) &#123;</span><br><span class="line">      selectedMap.<span class="title function_">get</span>(key).<span class="title function_">push</span>(val)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// 这个selectedMap的结构是</span></span><br><span class="line">  <span class="comment">// Map&lt;&#123;</span></span><br><span class="line">  <span class="comment">//   key: 一级code,</span></span><br><span class="line">  <span class="comment">//   value: [二级code]</span></span><br><span class="line">  <span class="comment">// &#125;&gt;</span></span><br><span class="line">  <span class="comment">// 获取已选项的一级的code</span></span><br><span class="line">  <span class="keyword">const</span> selectKeys = [...selectedMap.<span class="title function_">keys</span>()]</span><br><span class="line">  selectKeys.<span class="title function_">forEach</span>(<span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 比较已选的二级和源数据二级的长度</span></span><br><span class="line">    <span class="comment">// 长度相等则改变一级分类的选中态</span></span><br><span class="line">    <span class="keyword">if</span> (selectedMap.<span class="title function_">get</span>(key).<span class="property">length</span> === (<span class="variable constant_">RELATETYPELISTMAP</span>.<span class="title function_">get</span>(key)?.<span class="property">sub_type</span> ?? []).<span class="property">length</span>) &#123;</span><br><span class="line">      groupStatus[key] = <span class="literal">true</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      groupStatus[key] = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="处理点击一级分类"><a href="#处理点击一级分类" class="headerlink" title="处理点击一级分类"></a>处理点击一级分类</h5><p>当点击<code>一级分类</code>的时候需要选中它下面的所有<code>二级分类</code></p><p>点击的时候判断点击的这个<code>一级分类</code>是否已经全选，分两种情况处理具体实现思路如下：</p><ul><li>如果已经全选则取消全选，同时删除他下面<code>二级分类</code>的选中态</li><li>如果不是全选，则把当前<code>一级分类</code>下面的没有被选择的<code>二级分类</code>加到v-model的数据里，同时<code>一级分类</code>状态切换为已选</li></ul><p>具体代码实现如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 点击一级分类时</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; <span class="variable">group</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">handleClickGroup</span> = (<span class="params">group</span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 获取子项, 如果不存在二级分类就把当前的一级分类拿出来</span></span><br><span class="line">  <span class="keyword">const</span> childrens = !<span class="variable constant_">RELATETYPELISTMAP</span>.<span class="title function_">get</span>(group.<span class="property">code</span>).<span class="property">sub_type</span>?.<span class="property">length</span> ? [group] : <span class="variable constant_">RELATETYPELISTMAP</span>.<span class="title function_">get</span>(group.<span class="property">code</span>).<span class="property">sub_type</span></span><br><span class="line">  <span class="comment">// 获取子项code</span></span><br><span class="line">  <span class="keyword">const</span> childrensCode = childrens.<span class="title function_">map</span>(<span class="function">(<span class="params">val</span>) =&gt;</span> val.<span class="property">code</span>)</span><br><span class="line">  <span class="comment">// 获取已选的code</span></span><br><span class="line">  <span class="keyword">const</span> selected = <span class="keyword">new</span> <span class="title class_">Set</span>(selectValue.<span class="property">value</span>)</span><br><span class="line">  <span class="comment">// 如果当前组已经是全选了，则删除已选的</span></span><br><span class="line">  <span class="keyword">if</span> (groupStatus[group.<span class="property">code</span>]) &#123;</span><br><span class="line">    <span class="comment">// 删除已选的里面包含的子项</span></span><br><span class="line">    childrensCode.<span class="title function_">forEach</span>(<span class="function"><span class="params">code</span> =&gt;</span> &#123;</span><br><span class="line">      selected.<span class="title function_">delete</span>(code)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// 重新给select赋值</span></span><br><span class="line">    selectValue.<span class="property">value</span> = [...selected]</span><br><span class="line">    <span class="comment">// 改变当前组的选中态</span></span><br><span class="line">    groupStatus[group.<span class="property">code</span>] = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 往里塞当前组的code</span></span><br><span class="line">  childrensCode.<span class="title function_">forEach</span>(<span class="function"><span class="params">code</span> =&gt;</span> &#123;</span><br><span class="line">    selected.<span class="title function_">add</span>(code)</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">// 重新给select赋值</span></span><br><span class="line">  selectValue.<span class="property">value</span> = [...selected]</span><br><span class="line">  <span class="comment">// 改变当前组的选中态</span></span><br><span class="line">  groupStatus[group.<span class="property">code</span>] = <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// useSelectData</span></span><br><span class="line"><span class="keyword">import</span> &#123; computed, reactive &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * props类型</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> propsType = &#123;</span><br><span class="line">  <span class="attr">value</span>: &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="title class_">Object</span>,</span><br><span class="line">    <span class="attr">required</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">disabled</span>: &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="title class_">Boolean</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">placeholder</span>: &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="title class_">String</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * emit的类型</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> emitType = [<span class="string">&#x27;update:value&#x27;</span>, <span class="string">&#x27;changeRelateType&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * relateType select 组件内部绑定的value的getter函数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">&#123;[key as Stirng]: Array</span>&#125;&#125; value 外部传入的双向绑定对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@example</span></span></span><br><span class="line"><span class="comment"> * // value demo</span></span><br><span class="line"><span class="comment"> * const value = &#123;</span></span><br><span class="line"><span class="comment"> *  1010: [1101, 1102, 1103]</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> * const val = getValue(value) // [&#x27;1010.1101&#x27;, &#x27;1010.1102&#x27;, &#x27;1010.1103&#x27;]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">getValue</span> = (<span class="params">value = &#123;&#125;</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> v = []</span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">entries</span>(value).<span class="title function_">forEach</span>(<span class="function">(<span class="params">[key, subVal]</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (subVal.<span class="property">length</span>) &#123;</span><br><span class="line">      subVal.<span class="title function_">forEach</span>(<span class="function">(<span class="params">val</span>) =&gt;</span> &#123;</span><br><span class="line">        v.<span class="title function_">push</span>(<span class="string">`<span class="subst">$&#123;key&#125;</span>.<span class="subst">$&#123;val&#125;</span>`</span>)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      v.<span class="title function_">push</span>(<span class="string">`<span class="subst">$&#123;key&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> v</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 响应式返回给上一层的数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Array&lt;String&gt;</span>&#125; <span class="variable">value</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> &#123;<span class="type">&#123;[key as String]: Array</span>&#125;&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">setValue</span> = (<span class="params">value</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> vMap = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">  value.<span class="title function_">forEach</span>(<span class="function">(<span class="params">val</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> [key, subVal] = val.<span class="title function_">split</span>(<span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> (!vMap.<span class="title function_">has</span>(key)) &#123;</span><br><span class="line">      vMap.<span class="title function_">set</span>(key, [])</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (subVal) &#123;</span><br><span class="line">      vMap.<span class="title function_">get</span>(key).<span class="title function_">push</span>(subVal)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">if</span> (!vMap.<span class="property">size</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">undefined</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Object</span>.<span class="title function_">fromEntries</span>([...vMap.<span class="title function_">entries</span>()])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 下拉框渲染options的源数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">localListToMap</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> localList = [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&#x27;code&#x27;</span>: <span class="number">10</span>,</span><br><span class="line">      <span class="string">&#x27;desc&#x27;</span>: <span class="string">&#x27;分组1&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;children&#x27;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&#x27;code&#x27;</span>: <span class="number">1010</span>,</span><br><span class="line">          <span class="string">&#x27;desc&#x27;</span>: <span class="string">&#x27;类型一级&#x27;</span>,</span><br><span class="line">          <span class="string">&#x27;sub_type&#x27;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="string">&#x27;code&#x27;</span>: <span class="number">1020</span>,</span><br><span class="line">              <span class="string">&#x27;desc&#x27;</span>: <span class="string">&#x27;类型二级1&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">          ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&#x27;code&#x27;</span>: <span class="number">1011</span>,</span><br><span class="line">          <span class="string">&#x27;desc&#x27;</span>: <span class="string">&#x27;类型一级2&#x27;</span>,</span><br><span class="line">          <span class="string">&#x27;sub_type&#x27;</span>: []</span><br><span class="line">        &#125;,</span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&#x27;code&#x27;</span>: <span class="number">20</span>,</span><br><span class="line">      <span class="string">&#x27;desc&#x27;</span>: <span class="string">&#x27;分组2&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;children&#x27;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&#x27;code&#x27;</span>: <span class="number">2010</span>,</span><br><span class="line">          <span class="string">&#x27;desc&#x27;</span>: <span class="string">&#x27;类型一级&#x27;</span>,</span><br><span class="line">          <span class="string">&#x27;sub_type&#x27;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="string">&#x27;code&#x27;</span>: <span class="number">1020</span>,</span><br><span class="line">              <span class="string">&#x27;desc&#x27;</span>: <span class="string">&#x27;类型二级1&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">          ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&#x27;code&#x27;</span>: <span class="number">2011</span>,</span><br><span class="line">          <span class="string">&#x27;desc&#x27;</span>: <span class="string">&#x27;类型一级2&#x27;</span>,</span><br><span class="line">          <span class="string">&#x27;sub_type&#x27;</span>: []</span><br><span class="line">        &#125;,</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">  <span class="keyword">const</span> localListMap = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">  <span class="comment">// 把最外层的分组跟第一级类型摊平</span></span><br><span class="line">  localList.<span class="title function_">forEach</span>(<span class="function">(<span class="params">parent</span>) =&gt;</span> &#123;</span><br><span class="line">    localListMap.<span class="title function_">set</span>(<span class="string">`<span class="subst">$&#123;parent.code&#125;</span>`</span>, &#123; <span class="attr">code</span>: <span class="string">`<span class="subst">$&#123;parent.code&#125;</span>`</span>, <span class="attr">desc</span>: parent.<span class="property">desc</span>, <span class="attr">isTitle</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">    parent.<span class="property">children</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">d</span> =&gt;</span> &#123;</span><br><span class="line">      localListMap.<span class="title function_">set</span>(<span class="string">`<span class="subst">$&#123;d.code&#125;</span>`</span>, &#123; ...d, <span class="attr">code</span>: <span class="string">`<span class="subst">$&#123;d.code&#125;</span>`</span>, <span class="attr">sub_type</span>: d.<span class="property">sub_type</span>?.<span class="title function_">map</span>(<span class="function"><span class="params">child</span> =&gt;</span> (&#123; ...child, <span class="attr">code</span>: <span class="string">`<span class="subst">$&#123;d.code&#125;</span>.<span class="subst">$&#123;child.code&#125;</span>`</span> &#125;)) &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">// 根据一级code和分组code 组成Map</span></span><br><span class="line">  <span class="keyword">return</span> localListMap</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">useSelectData</span> = (<span class="params">props, emit</span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// map结构，一级code做key</span></span><br><span class="line">  <span class="keyword">const</span> <span class="variable constant_">RELATETYPELISTMAP</span> = <span class="title function_">localListToMap</span>()</span><br><span class="line">  <span class="comment">// 所有一级对应的数据，包含二级数据</span></span><br><span class="line">  <span class="keyword">const</span> <span class="variable constant_">RELATETYPELIST</span> = [...<span class="variable constant_">RELATETYPELISTMAP</span>.<span class="title function_">values</span>()]</span><br><span class="line">  <span class="comment">// 所有一级分组的选中态， filter过滤掉最外层只展示的分组</span></span><br><span class="line">  <span class="keyword">const</span> groupStatus = <span class="title function_">reactive</span>(</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">fromEntries</span>([...<span class="variable constant_">RELATETYPELISTMAP</span>.<span class="title function_">entries</span>()]</span><br><span class="line">      .<span class="title function_">filter</span>(<span class="function">(<span class="params">[key, val]</span>) =&gt;</span> !val.<span class="property">isTitle</span>)</span><br><span class="line">      .<span class="title function_">map</span>(<span class="function">(<span class="params">[key, val]</span>) =&gt;</span> [key, <span class="literal">false</span>]))</span><br><span class="line">  )</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 双向绑定的处理</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">const</span> selectValue = <span class="title function_">computed</span>(&#123;</span><br><span class="line">    <span class="attr">get</span>: <span class="function">() =&gt;</span> <span class="title function_">getValue</span>(props.<span class="property">value</span>),</span><br><span class="line">    <span class="attr">set</span>: <span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> v = <span class="title function_">setValue</span>(value)</span><br><span class="line">      <span class="title function_">emit</span>(<span class="string">&#x27;update:value&#x27;</span>, v)</span><br><span class="line">      <span class="title function_">emit</span>(<span class="string">&#x27;changeRelateType&#x27;</span>, v)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 选项改变时</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">handleChange</span> = (<span class="params">value</span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 如果清空选项把group的选中态清空</span></span><br><span class="line">    <span class="keyword">if</span> (!value.<span class="property">length</span>) &#123;</span><br><span class="line">      <span class="title class_">Object</span>.<span class="title function_">keys</span>(groupStatus).<span class="title function_">forEach</span>(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">        groupStatus[key] = <span class="literal">false</span></span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> selectedMap = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">    <span class="comment">// 将已选项处理成一个Map</span></span><br><span class="line">    value.<span class="title function_">forEach</span>(<span class="function">(<span class="params">v</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> [key, val] = v.<span class="title function_">split</span>(<span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">      <span class="keyword">if</span> (!selectedMap.<span class="title function_">has</span>(key)) &#123;</span><br><span class="line">        selectedMap.<span class="title function_">set</span>(key, [])</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (val) &#123;</span><br><span class="line">        selectedMap.<span class="title function_">get</span>(key).<span class="title function_">push</span>(val)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 获取已选项的一级的code</span></span><br><span class="line">    <span class="keyword">const</span> selectKeys = [...selectedMap.<span class="title function_">keys</span>()]</span><br><span class="line">    selectKeys.<span class="title function_">forEach</span>(<span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 比较已选的二级和源数据二级的长度</span></span><br><span class="line">      <span class="comment">// 长度相等则改变group的选中态</span></span><br><span class="line">      <span class="keyword">if</span> (selectedMap.<span class="title function_">get</span>(key).<span class="property">length</span> === (<span class="variable constant_">RELATETYPELISTMAP</span>.<span class="title function_">get</span>(key)?.<span class="property">sub_type</span> ?? []).<span class="property">length</span>) &#123;</span><br><span class="line">        groupStatus[key] = <span class="literal">true</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        groupStatus[key] = <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 点击select group时</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; <span class="variable">group</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">handleClickGroup</span> = (<span class="params">group</span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">// title只做展示用的点了也不给他处理</span></span><br><span class="line">    <span class="keyword">if</span> (group.<span class="property">isTitle</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取子项</span></span><br><span class="line">    <span class="keyword">const</span> childrens = !<span class="variable constant_">RELATETYPELISTMAP</span>.<span class="title function_">get</span>(group.<span class="property">code</span>).<span class="property">sub_type</span>?.<span class="property">length</span> ? [group] : <span class="variable constant_">RELATETYPELISTMAP</span>.<span class="title function_">get</span>(group.<span class="property">code</span>).<span class="property">sub_type</span></span><br><span class="line">    <span class="comment">// 获取子项code</span></span><br><span class="line">    <span class="keyword">const</span> childrensCode = childrens.<span class="title function_">map</span>(<span class="function">(<span class="params">val</span>) =&gt;</span> val.<span class="property">code</span>)</span><br><span class="line">    <span class="comment">// 获取已选的code</span></span><br><span class="line">    <span class="keyword">const</span> selected = <span class="keyword">new</span> <span class="title class_">Set</span>(selectValue.<span class="property">value</span>)</span><br><span class="line">    <span class="comment">// 如果当前组已经是全选了</span></span><br><span class="line">    <span class="keyword">if</span> (groupStatus[group.<span class="property">code</span>]) &#123;</span><br><span class="line">      <span class="comment">// 删除已选的里面包含的子项</span></span><br><span class="line">      childrensCode.<span class="title function_">forEach</span>(<span class="function"><span class="params">code</span> =&gt;</span> &#123;</span><br><span class="line">        selected.<span class="title function_">delete</span>(code)</span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="comment">// 重新给select赋值</span></span><br><span class="line">      selectValue.<span class="property">value</span> = [...selected]</span><br><span class="line">      <span class="comment">// 改变当前组的选中态</span></span><br><span class="line">      groupStatus[group.<span class="property">code</span>] = <span class="literal">false</span></span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 往里塞当前组的code</span></span><br><span class="line">    childrensCode.<span class="title function_">forEach</span>(<span class="function"><span class="params">code</span> =&gt;</span> &#123;</span><br><span class="line">      selected.<span class="title function_">add</span>(code)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// 重新给select赋值</span></span><br><span class="line">    selectValue.<span class="property">value</span> = [...selected]</span><br><span class="line">    <span class="comment">// 改变当前组的选中态</span></span><br><span class="line">    groupStatus[group.<span class="property">code</span>] = <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="variable constant_">RELATETYPELIST</span>,</span><br><span class="line">    groupStatus,</span><br><span class="line">    selectValue,</span><br><span class="line">    handleChange,</span><br><span class="line">    handleClickGroup</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> useSelectData</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">el-select</span> <span class="attr">v-model</span>=<span class="string">&quot;selectValue&quot;</span> <span class="attr">:placeholder</span>=<span class="string">&quot;props.placeholder || &#x27;请选择&#x27;&quot;</span> <span class="attr">multiple</span> <span class="attr">clearable</span> <span class="attr">:disabled</span>=<span class="string">&quot;props.disabled&quot;</span> @<span class="attr">change</span>=<span class="string">&quot;handleChange&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">template</span> <span class="attr">v-for</span>=<span class="string">&quot;group in RELATETYPELIST&quot;</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- 分组 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">el-option</span> <span class="attr">class</span>=<span class="string">&quot;el-select-group__title group&quot;</span> <span class="attr">:key</span>=<span class="string">&quot;group.code&quot;</span> <span class="attr">v-if</span>=<span class="string">&quot;group.isTitle&quot;</span> <span class="attr">:label</span>=<span class="string">&quot;`$&#123;group.desc&#125;`&quot;</span> <span class="attr">:value</span>=<span class="string">&quot;group.code&quot;</span> <span class="attr">disabled</span>&gt;</span>&#123;&#123; group.desc &#125;&#125;<span class="tag">&lt;/<span class="name">el-option</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">template</span> <span class="attr">v-else</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 两级，这个充当一级 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span></span></span><br><span class="line"><span class="tag">          <span class="attr">v-if</span>=<span class="string">&quot;group.sub_type &amp;&amp; !!group.sub_type.length&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">:key</span>=<span class="string">&quot;group.code&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">&quot;el-select-group__title group can-select&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">:class</span>=<span class="string">&quot;&#123; &#x27;all-selected&#x27;: groupStatus[group.code] &#125;&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">:label</span>=<span class="string">&quot;`$&#123;group.desc&#125;`&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">:value</span>=<span class="string">&quot;group.code&quot;</span></span></span><br><span class="line"><span class="tag">          @<span class="attr">click</span>=<span class="string">&quot;handleClickGroup(group)&quot;</span></span></span><br><span class="line"><span class="tag">        &gt;</span>&#123;&#123; group.desc &#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 只有一级的时候 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">el-option</span> <span class="attr">v-else</span> <span class="attr">class</span>=<span class="string">&quot;group can-select&quot;</span> <span class="attr">:key</span>=<span class="string">&quot;group.code&quot;</span> <span class="attr">:label</span>=<span class="string">&quot;`$&#123;group.desc&#125;`&quot;</span> <span class="attr">:value</span>=<span class="string">&quot;group.code&quot;</span>&gt;</span>&#123;&#123; group.desc &#125;&#125;<span class="tag">&lt;/<span class="name">el-option</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">el-option</span> <span class="attr">class</span>=<span class="string">&quot;pl-30&quot;</span> <span class="attr">v-for</span>=<span class="string">&quot;item in group.sub_type&quot;</span> <span class="attr">:key</span>=<span class="string">&quot;item.code&quot;</span> <span class="attr">:label</span>=<span class="string">&quot;`$&#123;group.desc&#125;-$&#123;item.desc&#125;`&quot;</span> <span class="attr">:value</span>=<span class="string">&quot;item.code&quot;</span>&gt;</span></span><br><span class="line">          &#123;&#123;item.desc&#125;&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">el-option</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">el-select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> useSelectData, &#123; propsType, emitType &#125; <span class="keyword">from</span> <span class="string">&#x27;./useSelectData&#x27;</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> &#123; onMounted &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> props = <span class="title function_">defineProps</span>(propsType)</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> emit = <span class="title function_">defineEmits</span>(emitType)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> &#123; selectValue, groupStatus, <span class="variable constant_">RELATETYPELIST</span>, handleChange, handleClickGroup &#125; = <span class="title function_">useSelectData</span>(props, emit)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="title function_">onMounted</span>(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="title function_">handleChange</span>(selectValue.<span class="property">value</span>)</span></span><br><span class="line"><span class="language-javascript">&#125;)</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">scoped</span> <span class="attr">lang</span>=<span class="string">&quot;scss&quot;</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css"><span class="selector-class">.group</span> &#123;</span></span><br><span class="line"><span class="language-css">  &amp;<span class="selector-class">.can-select</span> &#123;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">cursor</span>: pointer;</span></span><br><span class="line"><span class="language-css">  &#125;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.all-selected</span> &#123;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">color</span>: <span class="number">#409EFF</span>;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.pl-30</span> &#123;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">padding-left</span>: <span class="number">30px</span>;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> 组件二次封装 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Vue 源码解析(1)</title>
      <link href="/2023/05/23/Vue-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-1/"/>
      <url>/2023/05/23/Vue-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-1/</url>
      
        <content type="html"><![CDATA[<h2 id="Vue源码分析-CreateApp"><a href="#Vue源码分析-CreateApp" class="headerlink" title="Vue源码分析-CreateApp"></a>Vue源码分析-CreateApp</h2><h3 id="官网解释"><a href="#官网解释" class="headerlink" title="官网解释"></a>官网解释</h3><p>创建一个应用实例</p><ul><li><p>类型</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createApp</span>(<span class="params">rootComponent: Component, rootProps?: <span class="built_in">object</span></span>): <span class="title class_">App</span></span><br></pre></td></tr></table></figure></li><li><p>详细信息</p><p>第一个参数是根组件。第二个参数可选，它是要传递给根组件的 props。</p></li><li><p>示例</p><p>可以直接内联根组件：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createApp &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">createApp</span>(&#123;</span><br><span class="line">  <span class="comment">/* root component options */</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>也可以使用从别处导入的组件：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createApp &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;./App.vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">createApp</span>(<span class="title class_">App</span>)</span><br></pre></td></tr></table></figure></li><li><p>源码位置</p><p>packages/runtime-core/src/apiCreateApp.ts</p></li><li><p>函数名</p><p>createAppAPI</p></li><li><p>mini-vue中的实现（简化版vue实现）</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createAppAPI</span>(<span class="params">render</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">createApp</span>(<span class="params">rootComponent</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> app = &#123;</span><br><span class="line">      <span class="attr">_component</span>: rootComponent,</span><br><span class="line">      <span class="title function_">mount</span>(<span class="params">rootContainer</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;基于根组件创建 vnode&quot;</span>);</span><br><span class="line">        <span class="keyword">const</span> vnode = <span class="title function_">createVNode</span>(rootComponent);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;调用 render，基于 vnode 进行开箱&quot;</span>);</span><br><span class="line">        <span class="title function_">render</span>(vnode, rootContainer);</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> app;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="createApp源码内函数处理"><a href="#createApp源码内函数处理" class="headerlink" title="createApp源码内函数处理"></a>createApp源码内函数处理</h3><ul><li><p>部分源码</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> createAppAPI&lt;<span class="title class_">HostElement</span>&gt;(</span><br><span class="line">  <span class="attr">render</span>: <span class="title class_">RootRenderFunction</span>&lt;<span class="title class_">HostElement</span>&gt;,</span><br><span class="line">  hydrate?: <span class="title class_">RootHydrateFunction</span></span><br><span class="line">): <span class="title class_">CreateAppFunction</span>&lt;<span class="title class_">HostElement</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="title function_">isFunction</span>(rootComponent)) &#123;</span><br><span class="line">    rootComponent = <span class="title function_">extend</span>(&#123;&#125;, rootComponent)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (rootProps != <span class="literal">null</span> &amp;&amp; !<span class="title function_">isObject</span>(rootProps)) &#123;</span><br><span class="line">    __DEV__ &amp;&amp; <span class="title function_">warn</span>(<span class="string">`root props passed to app.mount() must be an object.`</span>)</span><br><span class="line">    rootProps = <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> context = <span class="title function_">createAppContext</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">app</span>: <span class="title class_">App</span> = (context.<span class="property">app</span> = &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__COMPAT__) &#123;</span><br><span class="line">    <span class="title function_">installAppCompatProperties</span>(app, context, render)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> app</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>创建context源码</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// createApp经过一些列判断之后使用createAppContext，创建了一个空的根组件对象</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createAppContext</span>(<span class="params"></span>): <span class="title class_">AppContext</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">app</span>: <span class="literal">null</span> <span class="keyword">as</span> <span class="built_in">any</span>,</span><br><span class="line">    <span class="attr">config</span>: &#123;</span><br><span class="line">      <span class="attr">isNativeTag</span>: <span class="variable constant_">NO</span>,</span><br><span class="line">      <span class="attr">performance</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">globalProperties</span>: &#123;&#125;,</span><br><span class="line">      <span class="attr">optionMergeStrategies</span>: &#123;&#125;,</span><br><span class="line">      <span class="attr">errorHandler</span>: <span class="literal">undefined</span>,</span><br><span class="line">      <span class="attr">warnHandler</span>: <span class="literal">undefined</span>,</span><br><span class="line">      <span class="attr">compilerOptions</span>: &#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">mixins</span>: [],</span><br><span class="line">    <span class="attr">components</span>: &#123;&#125;,</span><br><span class="line">    <span class="attr">directives</span>: &#123;&#125;,</span><br><span class="line">    <span class="attr">provides</span>: <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>),</span><br><span class="line">    <span class="attr">optionsCache</span>: <span class="keyword">new</span> <span class="title class_">WeakMap</span>(),</span><br><span class="line">    <span class="attr">propsCache</span>: <span class="keyword">new</span> <span class="title class_">WeakMap</span>(),</span><br><span class="line">    <span class="attr">emitsCache</span>: <span class="keyword">new</span> <span class="title class_">WeakMap</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>创建完context后，给context.app赋值, 其中包含的属性及含义：</p><ul><li><p>_uid</p></li><li><p>_component（createApp传入的rootComponent处理来的）</p></li><li><p>_props（createApp传入的rootProps处理来的）</p></li><li><p>_container mount传入的rootContainer</p></li><li><p>_context（context实例）</p></li><li><p>_instance (mount时创建的vnode的component)</p></li><li><p>version（Vue版本）</p></li><li><p>config</p><p>特殊处理设置getter、setter</p><p>getter 返回 context.config</p><p>setter 开发环境提示不让直接更改该属性</p></li><li><p>use 对应app.use(plugin: Plugin, …options: any[])</p></li><li><p>mixin 方法</p><p>如果支持选项式API则将传入的mixin存放到context.mixins<br>内部有去重处理</p></li><li><p>component 同app.component()</p></li><li><p>directive 同 app.directive()</p></li><li><p>mount</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">mount</span>(</span><br><span class="line">  <span class="attr">rootContainer</span>: <span class="title class_">HostElement</span>,</span><br><span class="line">  isHydrate?: <span class="built_in">boolean</span>,</span><br><span class="line">  isSVG?: <span class="built_in">boolean</span></span><br><span class="line">): <span class="built_in">any</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// 创建vnode</span></span><br><span class="line">  <span class="keyword">const</span> vnode = <span class="title function_">createVNode</span>(rootComponent, rootProps)</span><br><span class="line">  <span class="comment">// store app context on the root VNode.</span></span><br><span class="line">  <span class="comment">// this will be set on the root instance on initial mount.</span></span><br><span class="line">  <span class="comment">// 将当前的上下文给vnode挂上</span></span><br><span class="line">  vnode.<span class="property">appContext</span> = context</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// 判断用那个函数渲染</span></span><br><span class="line">  <span class="keyword">if</span> (isHydrate &amp;&amp; hydrate) &#123;</span><br><span class="line">    <span class="title function_">hydrate</span>(vnode <span class="keyword">as</span> <span class="title class_">VNode</span>&lt;<span class="title class_">Node</span>, <span class="title class_">Element</span>&gt;, rootContainer <span class="keyword">as</span> <span class="built_in">any</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_">render</span>(vnode, rootContainer, isSVG)</span><br><span class="line">  &#125;</span><br><span class="line">  app.<span class="property">_container</span> = rootContainer <span class="comment">// 将mount传入的rootContainer赋值给_container</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__DEV__ || __FEATURE_PROD_DEVTOOLS__) &#123;</span><br><span class="line">    <span class="comment">// 将vnode的component赋值给app的_instance</span></span><br><span class="line">    app.<span class="property">_instance</span> = vnode.<span class="property">component</span></span><br><span class="line">    <span class="title function_">devtoolsInitApp</span>(app, version)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 返回一个根组件实例</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">getExposeProxy</span>(vnode.<span class="property">component</span>!) || vnode.<span class="property">component</span>!.<span class="property">proxy</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>unmount</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">unmount</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="title function_">render</span>(<span class="literal">null</span>, app.<span class="property">_container</span>) <span class="comment">// 卸载应用</span></span><br><span class="line">  <span class="comment">// ... </span></span><br><span class="line">  app.<span class="property">_instance</span> = <span class="literal">null</span> <span class="comment">// 将_instance赋空</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">delete</span> app.<span class="property">_container</span>.<span class="property">__vue_app__</span> <span class="comment">// 删除__vue_app__标记</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>provide</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">provide</span>(<span class="params">key, value</span>) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// 提供一个值，可以在应用中的所有后代组件中注入使用</span></span><br><span class="line">  context.<span class="property">provides</span>[key <span class="keyword">as</span> <span class="built_in">string</span> | <span class="built_in">symbol</span>] = value</span><br><span class="line">  <span class="comment">// 返回当前实例可以链式调用</span></span><br><span class="line">  <span class="keyword">return</span> app</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>runWithContext <code>3.3+</code></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">runWithContext</span>(<span class="params">fn</span>) &#123;</span><br><span class="line">  <span class="comment">// 当前应用</span></span><br><span class="line">  currentApp = app</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 执行回调函数</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">fn</span>()</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    currentApp = <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><blockquote><p>app属性参考，官网地址: <a href="https://cn.vuejs.org/api/application.html">https://cn.vuejs.org/api/application.html</a></p></blockquote></li></ul>]]></content>
      
      
      <categories>
          
          <category> Vue </category>
          
          <category> CreateApp </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Vue </tag>
            
            <tag> 源码分析 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>webpack更换vite</title>
      <link href="/2022/11/07/webpack%E6%9B%B4%E6%8D%A2vite/"/>
      <url>/2022/11/07/webpack%E6%9B%B4%E6%8D%A2vite/</url>
      
        <content type="html"><![CDATA[<h2 id="为什么选择vite"><a href="#为什么选择vite" class="headerlink" title="为什么选择vite"></a>为什么选择vite</h2><p>借用vite官网的介绍<a href="%E4%B8%BA%E4%BB%80%E4%B9%88%E9%80%89%E6%8B%A9vite">https://cn.vitejs.dev/guide/why.html#the-problems</a><br>本人更换vite主要就是两个原因：</p><ol><li>webpack dev环境启动太慢了，公司项目启动平均要一分半钟；</li><li>webpack build需要的内存较大，公司项目平均2.3G内存；</li></ol><h2 id="初步准备"><a href="#初步准备" class="headerlink" title="初步准备"></a>初步准备</h2><ul><li>如果不想要webpack和vite共存，那么我建议直接新建一个文件夹。</li><li>我所用的项目为vue2.7项目（所以我会讲我用到的vue2.x的包，3.x的建议直接yarn create vite my-vue-app –template vue）。</li></ul><h2 id="更换过程"><a href="#更换过程" class="headerlink" title="更换过程"></a>更换过程</h2><ul><li><p>首先 npm init 创建package.json， 已有项目直接复制过来就好</p></li><li><p>安装必要的npm包，<code>vite</code>, <code>@vitejs/plugin-vue2</code>(vue3.x安装<code>@vitejs/plugin-vue</code>)，项目中需要的其他包根据自己的需要添加，以上为vite运行必须的包</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i vite @vitejs/plugin-vue2 -D</span><br></pre></td></tr></table></figure></li><li><p>新建vite.config.js文件</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vite.config.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; defineConfig &#125; <span class="keyword">from</span> <span class="string">&#x27;vite&#x27;</span></span><br><span class="line"><span class="keyword">import</span> vue <span class="keyword">from</span> <span class="string">&#x27;@vitejs/plugin-vue2&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; fileURLToPath &#125; <span class="keyword">from</span> <span class="string">&#x27;url&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(<span class="function">(<span class="params">&#123; command, mode &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  reutrn &#123;</span><br><span class="line">    <span class="comment">// 写vue的一般都用‘@’作为‘src’的别名，我这里就配了这一个，有需要则自行添加</span></span><br><span class="line">    <span class="attr">resolve</span>: &#123;</span><br><span class="line">      <span class="attr">alias</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;@&#x27;</span>: <span class="title function_">fileURLToPath</span>(<span class="keyword">new</span> <span class="title function_">URL</span>(<span class="string">&#x27;./src&#x27;</span>, <span class="keyword">import</span>.<span class="property">meta</span>.<span class="property">url</span>))</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">extensions</span>: [<span class="string">&#x27;.js&#x27;</span>, <span class="string">&#x27;.vue&#x27;</span>]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">plugins</span>: [</span><br><span class="line">      <span class="comment">// 解析vue2.x需要的插件</span></span><br><span class="line">      <span class="title function_">vue</span>()</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">server</span>: &#123;</span><br><span class="line">      <span class="comment">// dev环境代理服务</span></span><br><span class="line">      <span class="attr">proxy</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;/api&#x27;</span>: &#123;</span><br><span class="line">          <span class="attr">target</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">          <span class="attr">changeOrigin</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">rewrite</span>: <span class="function">(<span class="params">path</span>) =&gt;</span> path.<span class="title function_">replace</span>(<span class="string">&#x27;/api&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 打包时去掉debugger和console</span></span><br><span class="line">    <span class="attr">esbuild</span>: &#123;</span><br><span class="line">      <span class="attr">drop</span>: command === <span class="string">&#x27;build&#x27;</span> ? [<span class="string">&#x27;debugger&#x27;</span>, <span class="string">&#x27;console&#x27;</span>] : [],</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li><li><p>此时将旧版项目的src复制到新的项目下，目录结构为</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">src/</span><br><span class="line">  compontents/</span><br><span class="line">    **.vue</span><br><span class="line">  router/</span><br><span class="line">    index.js</span><br><span class="line">  store/</span><br><span class="line">    index.js</span><br><span class="line">  utils/</span><br><span class="line">  App.vue</span><br><span class="line">  main.js</span><br><span class="line">index.html</span><br><span class="line">jsconfig.json</span><br><span class="line">package.json</span><br><span class="line">vite.config.js</span><br></pre></td></tr></table></figure></li><li><p>main.js 需要进行调整</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 只有new Vue部分修改，其余部分可继续沿用，例如element-ui</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Vue</span> <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">&#x27;./router&#x27;</span></span><br><span class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">&#x27;./store/index.js&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ElementUI</span> <span class="keyword">from</span> <span class="string">&#x27;element-ui&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;element-ui/lib/theme-chalk/index.css&#x27;</span>;</span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">use</span>(<span class="title class_">ElementUI</span>); <span class="comment">// 全局使用ElementUI</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;./App&#x27;</span></span><br><span class="line"><span class="comment">// 原</span></span><br><span class="line"><span class="comment">// const instance = new Vue(&#123;</span></span><br><span class="line"><span class="comment">//   el: &#x27;#app&#x27;,</span></span><br><span class="line"><span class="comment">//   router,</span></span><br><span class="line"><span class="comment">//   store,</span></span><br><span class="line"><span class="comment">//   components: &#123; App &#125;,</span></span><br><span class="line"><span class="comment">//   template: &#x27;&lt;App/&gt;&#x27;</span></span><br><span class="line"><span class="comment">// &#125;)</span></span><br><span class="line"><span class="comment">// export default instance</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 现</span></span><br><span class="line"><span class="keyword">const</span> instance = <span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span><br><span class="line">  router,</span><br><span class="line">  store,</span><br><span class="line">  <span class="attr">render</span>: <span class="function">(<span class="params">h</span>) =&gt;</span> <span class="title function_">h</span>(<span class="title class_">App</span>)</span><br><span class="line">&#125;).$mount(<span class="string">&#x27;#app&#x27;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> instance</span><br></pre></td></tr></table></figure></li><li><p>index.html需要增加main.js的引用</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;module&quot;</span> <span class="attr">src</span>=<span class="string">&quot;/src/main.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul><p>此时项目应该可以运行起来了</p><h2 id="npm包在生产环境进行cdn引入"><a href="#npm包在生产环境进行cdn引入" class="headerlink" title="npm包在生产环境进行cdn引入"></a>npm包在生产环境进行cdn引入</h2><p>本人使用<code>rollup-plugin-external-globals</code>包进行cdn的使用</p><ul><li><p>安装 <code>rollup-plugin-external-globals</code>包</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i rollup-plugin-external-globals -D</span><br></pre></td></tr></table></figure></li><li><p>修改vite.config.js</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vite.config.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 省略上面配置过的</span></span><br><span class="line">... </span><br><span class="line"><span class="keyword">import</span> externalGlobals <span class="keyword">from</span> <span class="string">&#x27;rollup-plugin-external-globals&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(<span class="function">(<span class="params">&#123; command, mode &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  reutrn &#123;</span><br><span class="line">    <span class="comment">// 省略上面配置过的 </span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 增加build打包后cdn的配置</span></span><br><span class="line">    <span class="attr">build</span>: &#123;</span><br><span class="line">      <span class="attr">rollupOptions</span>: &#123;</span><br><span class="line">        <span class="comment">// 代码中引用的包名</span></span><br><span class="line">        <span class="attr">external</span>: [<span class="string">&#x27;vue&#x27;</span>, <span class="string">&#x27;vue-router&#x27;</span>, <span class="string">&#x27;element-ui&#x27;</span>],</span><br><span class="line">        <span class="attr">plugins</span>: [</span><br><span class="line">          <span class="comment">// 属性名为项目中使用的名字，值为cdn暴露的全局变量名</span></span><br><span class="line">          <span class="title function_">externalGlobals</span>(&#123;</span><br><span class="line">            <span class="attr">vue</span>: <span class="string">&#x27;Vue&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;vue-router&#x27;</span>: <span class="string">&#x27;VueRouter&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;element-ui&#x27;</span>: <span class="string">&#x27;ELEMENT&#x27;</span>,</span><br><span class="line">          &#125;)</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li><li><p>修改index.html</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;https://unpkg.com/element-ui@2.15.10/lib/theme-chalk/index.css&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">link</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://unpkg.com/vue@2.7.13/dist/vue.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://unpkg.com/element-ui@2.15.10&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://unpkg.com/vue-router@3.6.5&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;module&quot;</span> <span class="attr">src</span>=<span class="string">&quot;/src/main.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul><p>此时打包已经将<code>vue</code>、<code>element-ui</code>、<code>vue-router</code>排除了。</p><div class="note info flat"><p>使用<code>vite-plugin-html</code>可以进行html内的cdn自动导入</p></div><h2 id="cdn自动引入"><a href="#cdn自动引入" class="headerlink" title="cdn自动引入"></a>cdn自动引入</h2><p>使用<code>vite-plugin-html</code>包完成cdn自动引入index.html</p><ul><li><p>安装</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i vite-plugin-html -D</span><br></pre></td></tr></table></figure></li><li><p>创建一个js文件，我这里取名cdn.js</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// config/cdn.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="comment">// 属性名自己起</span></span><br><span class="line">  <span class="attr">js</span>: [</span><br><span class="line">    <span class="string">&#x27;https://unpkg.com/vue@2.7.13/dist/vue.js&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;https://unpkg.com/element-ui@2.15.10&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;https://unpkg.com/vue-router@3.6.5&#x27;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">css</span>: [</span><br><span class="line">    <span class="string">&#x27;https://unpkg.com/element-ui@2.15.10/lib/theme-chalk/index.css&#x27;</span></span><br><span class="line">  ]</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure></li><li><p>修改vite.config.js</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vite.config.js</span></span><br><span class="line"><span class="comment">// 省略上面配置过的</span></span><br><span class="line">... </span><br><span class="line"><span class="keyword">import</span> &#123; createHtmlPlugin &#125; <span class="keyword">from</span> <span class="string">&#x27;vite-plugin-html&#x27;</span></span><br><span class="line"><span class="keyword">import</span> cdn <span class="keyword">from</span> <span class="string">&#x27;/config/cdn.js&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(<span class="function">(<span class="params">&#123; command, mode &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  reutrn &#123;</span><br><span class="line">    <span class="comment">// 省略上面配置过的 </span></span><br><span class="line">    ...</span><br><span class="line">    <span class="attr">plugins</span>: [</span><br><span class="line">      ...</span><br><span class="line">      <span class="title function_">createHtmlPlugin</span>(&#123;</span><br><span class="line">        <span class="attr">minify</span>: <span class="literal">true</span>, <span class="comment">// 是否压缩 html</span></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 如果你想将 `index.html`存放在指定文件夹，可以修改它，否则不需要配置</span></span><br><span class="line"><span class="comment">        * <span class="doctag">@default</span> index.html</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="attr">template</span>: <span class="string">&quot;/index.html&quot;</span>,</span><br><span class="line">        <span class="attr">inject</span>: &#123;</span><br><span class="line">          <span class="attr">data</span>: &#123;</span><br><span class="line">            <span class="comment">// 这个属性名也是自己起</span></span><br><span class="line">            <span class="attr">injectScript</span>: cdn.<span class="property">js</span>,</span><br><span class="line">            <span class="attr">injectLink</span>: cdn.<span class="property">css</span>,</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;)</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li><li><p>修改index.html</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  &lt;% for (let i in injectLink) &#123; %&gt;</span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;&lt;%= injectLink[i] %&gt;&quot;</span> /&gt;</span></span><br><span class="line">  &lt;% &#125; %&gt;</span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 这里的injectScript就是vite.config.js里自己起的名 --&gt;</span></span><br><span class="line">  &lt;% for (let i in injectScript) &#123; %&gt;</span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;&lt;%= injectScript[i] %&gt;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  &lt;% &#125; %&gt;</span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;module&quot;</span> <span class="attr">src</span>=<span class="string">&quot;/src/main.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul><h2 id="启用Gzip"><a href="#启用Gzip" class="headerlink" title="启用Gzip"></a>启用Gzip</h2><ul><li><p>安装<code>vite-plugin-compression</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i vite-plugin-compression -D</span><br></pre></td></tr></table></figure></li><li><p>vite.config.js使用</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vite.config.js</span></span><br><span class="line">... <span class="comment">// 省略上面已有的</span></span><br><span class="line"><span class="keyword">import</span> viteCompression <span class="keyword">from</span> <span class="string">&#x27;vite-plugin-compression&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(<span class="function">(<span class="params">&#123; command, mode &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  reutrn &#123;</span><br><span class="line">    <span class="comment">// 省略上面配置过的 </span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 增加build打包后cdn的配置</span></span><br><span class="line">    <span class="attr">build</span>: &#123;</span><br><span class="line">      <span class="attr">rollupOptions</span>: &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="attr">plugins</span>: [</span><br><span class="line">          ...</span><br><span class="line">          <span class="title function_">viteCompression</span>()</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li></ul><h2 id="启用打包分析"><a href="#启用打包分析" class="headerlink" title="启用打包分析"></a>启用打包分析</h2><ul><li><p>安装<code>rollup-plugin-visualizer</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i rollup-plugin-visualizer -D</span><br></pre></td></tr></table></figure></li><li><p>vite.config.js中使用</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vite.config.js</span></span><br><span class="line"><span class="comment">// 省略上面配置过的</span></span><br><span class="line">... </span><br><span class="line"><span class="keyword">import</span> &#123; visualizer &#125; <span class="keyword">from</span> <span class="string">&#x27;rollup-plugin-visualizer&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(<span class="function">(<span class="params">&#123; command, mode &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  reutrn &#123;</span><br><span class="line">    <span class="comment">// 省略上面配置过的 </span></span><br><span class="line">    ...</span><br><span class="line">    <span class="attr">plugins</span>: [</span><br><span class="line">      ...</span><br><span class="line">      <span class="title function_">visualizer</span>(&#123; <span class="attr">open</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li></ul><h2 id="插件总结"><a href="#插件总结" class="headerlink" title="插件总结"></a>插件总结</h2><ul><li><code>vite</code> vite包</li><li><code>@vitejs/plugin-vue2</code> vue2.x语法解析</li><li><code>vite-plugin-compression</code> Gzip压缩</li><li><code>rollup-plugin-visualizer</code> 打包依赖分析</li><li><code>vite-plugin-eslint</code> eslint校验,需配合<code>eslint</code>, <code>@babel/eslint-parser</code>, <code>eslint-plugin-vue</code></li><li><code>@vitejs/plugin-vue2-jsx</code> vue2.x jsx插件</li><li><code>vite-plugin-mock</code> mock插件，需配合<code>mockjs</code>包</li><li><code>vite-plugin-html</code> html模版自动导入cdn</li></ul>]]></content>
      
      
      <categories>
          
          <category> 打包工具 </category>
          
          <category> vite </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 打包工具 </tag>
            
            <tag> vite </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JS算法基础-队列</title>
      <link href="/2022/01/07/JS%E7%AE%97%E6%B3%95%E5%9F%BA%E7%A1%80-%E9%98%9F%E5%88%97/"/>
      <url>/2022/01/07/JS%E7%AE%97%E6%B3%95%E5%9F%BA%E7%A1%80-%E9%98%9F%E5%88%97/</url>
      
        <content type="html"><![CDATA[<h1 id="队列的概念"><a href="#队列的概念" class="headerlink" title="队列的概念"></a>队列的概念</h1><p>​        队列是遵循FIFO（First In First Out，先进先出，也称为先来先服务）原则的一组有序的项。意如其名，就像排队一样，从尾部添加，从顶部移除，新添的元素必须排在队列的末尾。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">flowchart LR</span><br><span class="line">subgraph a[队列]</span><br><span class="line">q[...]--&gt;3--&gt;2</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">subgraph b[执行]</span><br><span class="line">q1[1]</span><br><span class="line">end</span><br><span class="line">2--&gt;q1</span><br></pre></td></tr></table></figure><h1 id="创建队列"><a href="#创建队列" class="headerlink" title="创建队列"></a>创建队列</h1><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Queue</span> &#123;</span><br><span class="line">  <span class="attr">items</span>: <span class="title class_">Array</span>&lt;<span class="built_in">any</span>&gt;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">items</span> = []</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 入队</span></span><br><span class="line"><span class="comment">   * 向队列尾部添加一个（或多个）新的项</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> <span class="variable">el</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">enqueue</span>(el): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (el <span class="keyword">instanceof</span> <span class="title class_">Array</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">items</span>.<span class="title function_">push</span>(...el)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">items</span>.<span class="title function_">push</span>(el)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 出队</span></span><br><span class="line"><span class="comment">   * 移除队列的第一（即排在队列最前面的）项，并返回被移除的元素</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">dequeue</span>(): <span class="built_in">any</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">items</span>.<span class="title function_">shift</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 返回队列中第一个元素——最先被添加，也将是最先被移除的元素。</span></span><br><span class="line"><span class="comment">   * 队列不做任何变动（不移除元素，只返回元素信息——与Stack类的peek方法非常类似）</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">front</span>(): <span class="built_in">any</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">items</span>[<span class="number">0</span>]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 判断队列是否为空</span></span><br><span class="line"><span class="comment">   * 如果队列中不包含任何元素，返回true，否则返回false</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">isEmpty</span>(): <span class="built_in">boolean</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">items</span>.<span class="property">length</span> === <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 返回队列包含的元素个数</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">size</span>(): <span class="built_in">number</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">items</span>.<span class="property">length</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="优先队列"><a href="#优先队列" class="headerlink" title="优先队列"></a>优先队列</h1><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">QueueElement</span>&lt;T, K&gt; &#123;</span><br><span class="line">  <span class="attr">element</span>: T</span><br><span class="line">  <span class="attr">priority</span>: K</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">el, priority</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">element</span> = el</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">priority</span> = priority</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PriorityQueue</span> &#123;</span><br><span class="line">  <span class="attr">items</span>: <span class="title class_">Array</span>&lt;<span class="built_in">any</span>&gt;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">items</span> = []</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@desc</span> 入队</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> el &#123;T&#125; 需要入队的元素</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> priority &#123;number&#125; 优先级</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  enqueue&lt;T&gt; (<span class="attr">el</span>: T, <span class="attr">priority</span>: <span class="built_in">number</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="comment">// 创建一个带优先级的对象</span></span><br><span class="line">    <span class="keyword">const</span> queueElement = <span class="keyword">new</span> <span class="title class_">QueueElement</span>&lt;T, <span class="built_in">number</span>&gt;(el, priority)</span><br><span class="line">    <span class="comment">// 判断队列是否为空，空就直接加进去</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="title function_">isEmpty</span>()) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">items</span>.<span class="title function_">push</span>(queueElement)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">//不为空判断该插在那个优先级前面</span></span><br><span class="line">      <span class="keyword">const</span> length = <span class="variable language_">this</span>.<span class="property">items</span>.<span class="property">length</span></span><br><span class="line">      <span class="keyword">let</span> added = <span class="literal">false</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">items</span>[i].<span class="property">priority</span> &gt; queueElement.<span class="property">priority</span>) &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">items</span>.<span class="title function_">splice</span>(i, <span class="number">0</span>, queueElement)</span><br><span class="line">          added = <span class="literal">true</span></span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 都不符合就放最后</span></span><br><span class="line">      <span class="keyword">if</span> (!added) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">items</span>.<span class="title function_">push</span>(queueElement)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@desc</span> 出队</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> QueueElement &#123;el, priority&#125; 返回一个带优先级的对象</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  dequeue (): <span class="title class_">QueueElement</span>&lt;<span class="built_in">any</span>, <span class="built_in">number</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">items</span>.<span class="title function_">shift</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@desc</span> 返回队列第一名但不改变队列</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> QueueElement &#123;el, priority&#125; 返回一个带优先级的对象</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  front (): <span class="title class_">QueueElement</span>&lt;<span class="built_in">any</span>, <span class="built_in">number</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;el, priority&#125; = <span class="variable language_">this</span>.<span class="property">items</span>[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">QueueElement</span>&lt;<span class="built_in">any</span>, <span class="built_in">number</span>&gt;(el, priority)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@desc</span> 返回队列长度</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> &#123;<span class="type">number</span>&#125;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  size (): <span class="built_in">number</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">items</span>.<span class="property">length</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@desc</span> 判断队列是否为空</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> &#123;<span class="type">boolean</span>&#125;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  isEmpty (): <span class="built_in">boolean</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> !<span class="variable language_">this</span>.<span class="property">items</span>.<span class="property">length</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> priorityQueue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>()</span><br><span class="line">priorityQueue.<span class="title function_">enqueue</span>(<span class="string">&#x27;b&#x27;</span>, <span class="number">2</span>)</span><br><span class="line">priorityQueue.<span class="title function_">enqueue</span>(<span class="string">&#x27;b&#x27;</span>, <span class="number">2</span>)</span><br><span class="line">priorityQueue.<span class="title function_">enqueue</span>(<span class="string">&#x27;a&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">priorityQueue.<span class="title function_">enqueue</span>(<span class="string">&#x27;c&#x27;</span>, <span class="number">3</span>)</span><br><span class="line">priorityQueue.<span class="title function_">enqueue</span>(<span class="string">&#x27;a&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">priorityQueue.<span class="title function_">enqueue</span>(<span class="string">&#x27;a&#x27;</span>, <span class="number">1</span>)</span><br><span class="line"><span class="comment">// QueueElement &#123; element: &#x27;a&#x27;, priority: 1 &#125;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(priorityQueue.<span class="title function_">dequeue</span>())</span><br><span class="line"><span class="comment">// [</span></span><br><span class="line"><span class="comment">//  QueueElement &#123; element: &#x27;a&#x27;, priority: 1 &#125;,</span></span><br><span class="line"><span class="comment">//  QueueElement &#123; element: &#x27;a&#x27;, priority: 1 &#125;,</span></span><br><span class="line"><span class="comment">//  QueueElement &#123; element: &#x27;b&#x27;, priority: 2 &#125;,</span></span><br><span class="line"><span class="comment">//  QueueElement &#123; element: &#x27;b&#x27;, priority: 2 &#125;,</span></span><br><span class="line"><span class="comment">//  QueueElement &#123; element: &#x27;c&#x27;, priority: 3 &#125;</span></span><br><span class="line"><span class="comment">// ]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(priorityQueue.<span class="property">items</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>本文参考自&lt;学习JavaScript数据结构与算法&gt;。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
          <category> 队列 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 算法 </tag>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>canvas基础画图库</title>
      <link href="/2021/11/02/canvas%E5%9F%BA%E7%A1%80%E7%94%BB%E5%9B%BE%E5%BA%93/"/>
      <url>/2021/11/02/canvas%E5%9F%BA%E7%A1%80%E7%94%BB%E5%9B%BE%E5%BA%93/</url>
      
        <content type="html"><![CDATA[<h2 id="画图库"><a href="#画图库" class="headerlink" title="画图库"></a>画图库</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 手写板</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@constructor</span></span></span><br><span class="line"><span class="comment"> *      <span class="doctag">@param</span> width 手写板宽度</span></span><br><span class="line"><span class="comment"> *      <span class="doctag">@param</span> height 手写板高度</span></span><br><span class="line"><span class="comment"> *      <span class="doctag">@param</span> lineW 线粗</span></span><br><span class="line"><span class="comment"> *      <span class="doctag">@param</span> lineColor 线颜色</span></span><br><span class="line"><span class="comment"> *      <span class="doctag">@param</span> bgColor 手写板颜色</span></span><br><span class="line"><span class="comment"> *      <span class="doctag">@param</span> El canvas节点Dom元素</span></span><br><span class="line"><span class="comment"> *      <span class="doctag">@param</span> historyLength 历史记录条数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@method</span> dataUrl 获取base64编码</span></span><br><span class="line"><span class="comment"> *      <span class="doctag">@param</span> mime 文件类型</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@method</span> dataURLtoBlob 获取blob文件</span></span><br><span class="line"><span class="comment"> *      <span class="doctag">@param</span> dataUrl base64编码</span></span><br><span class="line"><span class="comment"> *      <span class="doctag">@param</span> filename 文件名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@method</span> dataURLtoFile 获取file文件</span></span><br><span class="line"><span class="comment"> *      <span class="doctag">@param</span> dataUrl base64编码</span></span><br><span class="line"><span class="comment"> *      <span class="doctag">@param</span> filename 文件名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@method</span> downLoadUrl 获取下载地址</span></span><br><span class="line"><span class="comment"> *      <span class="doctag">@param</span> dataUrl base64编码</span></span><br><span class="line"><span class="comment"> *      <span class="doctag">@param</span> filename 文件名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@method</span> save 保存图片</span></span><br><span class="line"><span class="comment"> *      <span class="doctag">@param</span> mime 文件类型</span></span><br><span class="line"><span class="comment"> *      <span class="doctag">@param</span> filename 文件名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@method</span> clear 清空canvas区</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@method</span> getHistory 获取操作记录</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@method</span> upStep 上一步</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@method</span> nextStep 下一步</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@method</span> clearHistory 清空历史记录</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure><p>实现了鼠标画图，自定义颜色，历史记录，上一步，下一步等功能</p><p>如图所示：</p><p><img src="https://cdn.chrelyonly.cf/gh/011-01-10-110/static_resources@master/1635832336154.jpg" alt="示例"></p><div class="note danger flat"><p>没有写样式，只是为了展示基本功能</p></div><blockquote><p>地址：<a href="http://gitlab.wangblogs.top/wang/drawname">http://gitlab.wangblogs.top/wang/drawname</a></p><p>网站可能会很卡。。多等一会，请求超时的话刷新一下。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
          <category> canvas </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
            <tag> canvas </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JS算法基础-栈</title>
      <link href="/2021/10/28/JS%E7%AE%97%E6%B3%95%E5%9F%BA%E7%A1%80-%E6%A0%88/"/>
      <url>/2021/10/28/JS%E7%AE%97%E6%B3%95%E5%9F%BA%E7%A1%80-%E6%A0%88/</url>
      
        <content type="html"><![CDATA[<h1 id="栈的概念"><a href="#栈的概念" class="headerlink" title="栈的概念"></a>栈的概念</h1><p>​  栈是一种遵从后进先出（LIFO）原则的有序集合。新添加的或待删除的元素都保存在栈的末尾，称作栈顶，另一端就叫栈底。在栈里，新元素都靠近栈顶，旧元素都接近栈底。</p><p>​  栈作为一种数据结构，是一种只能在一端进行插入和删除操作的特殊线性表。它按照后进先出的原则存储数据，先进入的数据被压入栈底，最后的数据在栈顶，需要读数据的时候从栈顶开始弹出数据（最后一个数据被第一个读出来）。栈具有记忆作用，对栈的插入与删除操作中，不需要改变栈底指针。</p><p>​  通俗来讲，栈就好像一个箱子，我们放东西时从箱子顶部放入(入栈)，而最先放入的东西会被压到箱子底(栈底)，顺序放入依次从箱子底往上排，最后的东西在箱子口(栈顶)，需要拿东西的时候从箱子顶部依次拿(出栈)，</p><p>​  如图所示</p><p><img src="https://cdn.chrelyonly.cf/gh/011-01-10-110/static_resources@master/20211028-1.jpeg" alt="示例"></p><h1 id="栈的创建"><a href="#栈的创建" class="headerlink" title="栈的创建"></a>栈的创建</h1><p>在原生JS对象中并没有栈这个结构的定义，所以要使用栈就要先创造它。。。</p><p>我们先声明一个栈的类，这里使用数组去存储栈内的元素</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Stack</span> &#123;</span><br><span class="line">  items</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">items</span> = []</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>栈的数据结构需要一些必要的方法</p><p>如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// push(el)  添加一个新元素到栈顶(入栈)</span></span><br><span class="line"><span class="comment">// pop()   移除栈顶元素，同时返回被移除的元素(出栈)</span></span><br><span class="line"><span class="comment">// peek()   返回栈顶元素，不对栈做任何修改</span></span><br><span class="line"><span class="comment">// isEmpty() 判断栈是否为空，空返回true</span></span><br><span class="line"><span class="comment">// clear()  移除栈内所有元素</span></span><br><span class="line"><span class="comment">// size()   返回栈内元素个数</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Stack</span> &#123;</span><br><span class="line">  items</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">items</span> = []</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 入栈</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; el </span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">push</span>(<span class="params">el</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">items</span>.<span class="title function_">push</span>(el)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 出栈</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns</span> </span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">pop</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">items</span>.<span class="title function_">pop</span>()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 获取栈顶元素</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns</span> </span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">peek</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">items</span>[<span class="variable language_">this</span>.<span class="property">items</span>.<span class="property">length</span> - <span class="number">1</span>]</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 判断是否为空</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns</span> </span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">isEmpty</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">items</span>.<span class="property">length</span> === <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 清空栈元素</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">clear</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">items</span> = []</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 获取栈内元素个数</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns</span> </span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">size</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">items</span>.<span class="property">length</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="栈的使用"><a href="#栈的使用" class="headerlink" title="栈的使用"></a>栈的使用</h1><h2 id="十进制转二进制"><a href="#十进制转二进制" class="headerlink" title="十进制转二进制"></a>十进制转二进制</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">divideBy2</span>(<span class="params">n</span>) &#123;</span><br><span class="line">  <span class="comment">// 使用new创建stack实例</span></span><br><span class="line">  <span class="keyword">let</span> stack = <span class="keyword">new</span> <span class="title class_">Stack</span>()</span><br><span class="line">  <span class="comment">// 二进制字符串</span></span><br><span class="line">  <span class="keyword">let</span> binaryString = <span class="string">&#x27;&#x27;</span></span><br><span class="line">  <span class="keyword">while</span> (n &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// 取模入栈</span></span><br><span class="line">    <span class="keyword">let</span> rem = n % <span class="number">2</span></span><br><span class="line">    stack.<span class="title function_">push</span>(rem)</span><br><span class="line">    n = <span class="title class_">Math</span>.<span class="title function_">floor</span>(n / <span class="number">2</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> (!stack.<span class="title function_">isEmpty</span>()) &#123;</span><br><span class="line">    <span class="comment">// 逐个出栈加到结果字符串</span></span><br><span class="line">    binaryString += stack.<span class="title function_">pop</span>()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> binaryString</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>本文参考自&lt;学习JavaScript数据结构与算法&gt;,以及百度百科。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
          <category> 栈 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 算法 </tag>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>git基本操作</title>
      <link href="/2021/09/07/git%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C/"/>
      <url>/2021/09/07/git%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C/</url>
      
        <content type="html"><![CDATA[<h2 id="Git第一次提交代码到仓库"><a href="#Git第一次提交代码到仓库" class="headerlink" title="Git第一次提交代码到仓库"></a>Git第一次提交代码到仓库</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 初始化git仓库</span></span><br><span class="line">$ git init </span><br><span class="line"><span class="comment"># 添加当前目录的所有文件到暂存区</span></span><br><span class="line">$ git add .</span><br><span class="line"><span class="comment"># 提交暂存区到仓库并填写注释</span></span><br><span class="line">$ git commit -m <span class="string">&#x27;注释&#x27;</span></span><br><span class="line"><span class="comment"># 添加远程仓库</span></span><br><span class="line">$ git remote add origin git仓库远程地址</span><br><span class="line"><span class="comment"># 将本地仓库推送到远程</span></span><br><span class="line">$ git push -u origin master</span><br></pre></td></tr></table></figure><h2 id="Git拉取-检出分支"><a href="#Git拉取-检出分支" class="headerlink" title="Git拉取/检出分支"></a>Git拉取/检出分支</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 第一次克隆远程仓库</span></span><br><span class="line">$ git init</span><br><span class="line">$ git <span class="built_in">clone</span> 远程仓库地址</span><br><span class="line"><span class="comment"># 检出远程分支到本地</span></span><br><span class="line">$ git checkout -b 本地分支名 origin/远程分支名</span><br><span class="line"><span class="comment"># 基于commit提交创建分支</span></span><br><span class="line">$ git checkout -b 新分支 <span class="built_in">hash</span>值</span><br></pre></td></tr></table></figure><h2 id="Git新建分支"><a href="#Git新建分支" class="headerlink" title="Git新建分支"></a>Git新建分支</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建本地新分支</span></span><br><span class="line">$ git branch 新分支名</span><br><span class="line"><span class="comment"># 切换本地新分支</span></span><br><span class="line">$ git checkout 新分支名</span><br><span class="line"><span class="comment"># 创建并切换到新分支</span></span><br><span class="line">$ git checkout -b 新分支名</span><br><span class="line"><span class="comment"># push到远程分支</span></span><br><span class="line">$ git push origin 新分支名:新分支名</span><br><span class="line"><span class="comment"># 检出远程分支到本地</span></span><br><span class="line">$ git checkout -b 本地分支名 origin/远程分支名</span><br><span class="line"><span class="comment"># 设置跟踪远程分支</span></span><br><span class="line">$ git branch --set-upstream-to=origin/远程分支 本地分支</span><br></pre></td></tr></table></figure><h2 id="Git删除分支"><a href="#Git删除分支" class="headerlink" title="Git删除分支"></a>Git删除分支</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看本地分支</span></span><br><span class="line">$ git branch</span><br><span class="line"><span class="comment"># 查看本地和远程分支</span></span><br><span class="line">$ git branch -a</span><br><span class="line"><span class="comment"># 删除本地分支</span></span><br><span class="line">$ git branch -d 分支名</span><br><span class="line"><span class="comment"># 删除远程分支</span></span><br><span class="line">$ git push origin --delete 分支名</span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line">$ git push origin :分支名</span><br><span class="line"><span class="comment"># 清除本地无效分支</span></span><br><span class="line">$ git fetch -p</span><br></pre></td></tr></table></figure><h2 id="Git提交代码"><a href="#Git提交代码" class="headerlink" title="Git提交代码"></a>Git提交代码</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 拉取远程代码</span></span><br><span class="line">$ git pull</span><br><span class="line"><span class="comment"># 添加当前目录的所有文件到暂存区</span></span><br><span class="line">$ git add .</span><br><span class="line"><span class="comment"># 取消暂存到上一次提交，保留更改到工作区[文件名可选] --hard 将暂存区与工作区都回到上一次版本</span></span><br><span class="line">$ git reset HEAD [file]</span><br><span class="line"><span class="comment"># 提交暂存区到仓库并填写注释</span></span><br><span class="line">$ git commit -m <span class="string">&#x27;注释&#x27;</span></span><br><span class="line"><span class="comment"># 推送到远程</span></span><br><span class="line">$ git push</span><br></pre></td></tr></table></figure><h2 id="Git忽略上传文件或目录"><a href="#Git忽略上传文件或目录" class="headerlink" title="Git忽略上传文件或目录"></a>Git忽略上传文件或目录</h2><p>在.git文件夹同级新建.gitignore文件</p><p>忽略规则</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dirName// 忽略dirName目录</span><br><span class="line">文件名（带后缀名）// 忽略指定文件</span><br><span class="line">log/*// 忽略log下的所有文件</span><br><span class="line">css/*.css// 忽略css目录下的所有.css文件</span><br></pre></td></tr></table></figure><h2 id="Git贮藏"><a href="#Git贮藏" class="headerlink" title="Git贮藏"></a>Git贮藏</h2><p>当需要checkout出新的分支又不想提交当前改动时，利用贮藏储存然后checkout 新的分支，完成工作后继续上次的工作再应用贮藏的改动。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 执行储存[备注信息可选]</span></span><br><span class="line">$ git stash [save <span class="string">&quot;save message&quot;</span>]</span><br><span class="line"><span class="comment"># 查看贮藏列表</span></span><br><span class="line">$ git stash list</span><br><span class="line"><span class="comment"># 显示做了哪些改动默认为第一个，如果显示其他后面加@&#123;$num&#125;</span></span><br><span class="line">$ git stash show [stash@&#123;1&#125;]</span><br><span class="line"><span class="comment"># 显示具体的改动</span></span><br><span class="line">$ git stash show [stash@&#123;1&#125;] -p</span><br><span class="line"><span class="comment"># 应用贮藏</span></span><br><span class="line">$ git stash apply [stash@&#123;1&#125;]</span><br><span class="line"><span class="comment"># 恢复之前的贮藏并在stash列表中删除</span></span><br><span class="line">$ git stash pop [stash@&#123;1&#125;]</span><br><span class="line"><span class="comment"># 丢弃贮藏</span></span><br><span class="line">$ git stash drop [stash@&#123;1&#125;]</span><br><span class="line"><span class="comment"># 删除所有贮藏</span></span><br><span class="line">$ git stash clear</span><br></pre></td></tr></table></figure><div class="note red no-icon flat"><p>新增的文件不在git版本控制中不会贮藏，如果需要贮藏可以先<code>git add [file]</code>再进行贮藏</p></div>]]></content>
      
      
      <categories>
          
          <category> git </category>
          
      </categories>
      
      
        <tags>
            
            <tag> git </tag>
            
            <tag> 个人笔记 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JS深拷贝</title>
      <link href="/2021/08/18/JS%E6%B7%B1%E6%8B%B7%E8%B4%9D/"/>
      <url>/2021/08/18/JS%E6%B7%B1%E6%8B%B7%E8%B4%9D/</url>
      
        <content type="html"><![CDATA[<h2 id="赋值、深拷贝、浅拷贝区别"><a href="#赋值、深拷贝、浅拷贝区别" class="headerlink" title="赋值、深拷贝、浅拷贝区别"></a>赋值、深拷贝、浅拷贝区别</h2><h3 id="赋值"><a href="#赋值" class="headerlink" title="赋值"></a>赋值</h3><p>赋值是某一个<mark class="hl-label blue">数值</mark> 或<mark class="hl-label blue">变量</mark> 赋给某个<mark class="hl-label blue">变量</mark> 的过程，分为：</p><ul><li>基本数据类型：赋值后两个变量的值互相没有关联关系，改变其一不会引起另一个变量值变化。</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a = <span class="string">&#x27;abc&#x27;</span></span><br><span class="line"><span class="keyword">let</span> b = a</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b) <span class="comment">// &#x27;abc&#x27;</span></span><br><span class="line">a = <span class="string">&#x27;def&#x27;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a) <span class="comment">// &#x27;def&#x27;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b) <span class="comment">// &#x27;abc&#x27;</span></span><br></pre></td></tr></table></figure><blockquote><p>基本数据类型赋值时会在栈内存中创建一个新值。</p></blockquote><ul><li>引用数据类型：普通赋值操作使两个变量具有相同引用，指向同一个对象，改变任何一个，另一个取到的都会是改变后的值。</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a = &#123;</span><br><span class="line"> <span class="attr">name</span>: <span class="string">&#x27;abc&#x27;</span>,</span><br><span class="line"> <span class="attr">age</span>: <span class="number">20</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> b = a</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b) <span class="comment">// &#123;name: &quot;abc&quot;, age: 20&#125;</span></span><br><span class="line">a.<span class="property">name</span> = <span class="string">&#x27;def&#x27;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a) <span class="comment">// &#123;name: &quot;def&quot;, age: 20&#125;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b) <span class="comment">// &#123;name: &quot;def&quot;, age: 20&#125;</span></span><br></pre></td></tr></table></figure><blockquote><p>引用类型赋值时会在栈内存中存储引用对象的指针，真实对象在堆内存中。</p><p>想要得到两个相同值的引用类型的数据，又不想让它们指向同一个对象就需要用到深拷贝。</p></blockquote><h3 id="浅拷贝"><a href="#浅拷贝" class="headerlink" title="浅拷贝"></a>浅拷贝</h3><p>浅拷贝只是复制一层对象，当对象的属性是引用类型时，实际复制的是该属性的引用地址，当引用地址对应的值改变时，其他值为该引用地址的变量都会改变。</p><h4 id="浅拷贝-直接赋值"><a href="#浅拷贝-直接赋值" class="headerlink" title="浅拷贝-直接赋值"></a>浅拷贝-直接赋值</h4><p>该方法只能拷贝基本数据类型的值，引用类型的值第一层属性就会变成拷贝引用地址</p><blockquote><p>示例见赋值操作</p></blockquote><h4 id="浅拷贝-Object-assign"><a href="#浅拷贝-Object-assign" class="headerlink" title="浅拷贝-Object.assign()"></a>浅拷贝-<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/assign#%E6%8F%8F%E8%BF%B0">Object.assign()</a></h4><p><code>**Object.assign()**</code> 方法用于将所有可枚举属性的值从一个或多个源对象分配到目标对象。它将返回目标对象。</p><p>它会拷贝浅层引用类型对象的属性，<code>只会拷贝对象的第一层属性，对象内的引用类型属性只会拷贝引用地址</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;abc&#x27;</span>,</span><br><span class="line">    <span class="attr">shop</span>: &#123;</span><br><span class="line">        <span class="attr">price</span>: <span class="number">100</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> b = <span class="title class_">Object</span>.<span class="title function_">assign</span>(&#123;&#125;, a)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b) <span class="comment">// &#123;name: &quot;abc&quot;, shop: &#123;price: 100&#125;&#125;</span></span><br><span class="line"><span class="comment">// 当a的值改变时</span></span><br><span class="line">a.<span class="property">name</span> = <span class="string">&#x27;def&#x27;</span> <span class="comment">// 第一层属性</span></span><br><span class="line">a.<span class="property">shop</span>.<span class="property">price</span> = <span class="number">200</span> <span class="comment">// 第二层属性</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a) <span class="comment">// &#123;name: &quot;def&quot;, shop: &#123;price: 200&#125;&#125;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b) <span class="comment">// &#123;name: &quot;abc&quot;, shop: &#123;price: 200&#125;&#125;</span></span><br></pre></td></tr></table></figure><div class="note red no-icon flat"><p>当改变a的第二层属性时，b的属性值也改变了</p></div><h4 id="浅拷贝-‘…‘扩展运算符"><a href="#浅拷贝-‘…‘扩展运算符" class="headerlink" title="浅拷贝-‘…‘扩展运算符"></a>浅拷贝-‘<a href="https://es6.ruanyifeng.com/#docs/array#%E6%89%A9%E5%B1%95%E8%BF%90%E7%AE%97%E7%AC%A6">…</a>‘扩展运算符</h4><p>扩展运算符（spread）是三个点（<code>...</code>）。它好比 rest 参数的逆运算，将一个数组转为用逗号分隔的参数序列。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;abc&#x27;</span>,</span><br><span class="line">    <span class="attr">shop</span>: &#123;</span><br><span class="line">        <span class="attr">price</span>: <span class="number">100</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> b = &#123;...a&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b) <span class="comment">// &#123;name: &quot;abc&quot;, shop: &#123;price: 100&#125;&#125;</span></span><br><span class="line">a.<span class="property">name</span> = <span class="string">&#x27;def&#x27;</span></span><br><span class="line">a.<span class="property">shop</span>.<span class="property">price</span> = <span class="number">200</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a) <span class="comment">// &#123;name: &quot;def&quot;, shop: &#123;price: 200&#125;&#125;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b) <span class="comment">// &#123;name: &quot;abc&quot;, shop: &#123;price: 200&#125;&#125;</span></span><br></pre></td></tr></table></figure><div class="note red no-icon flat"><p>同Object.assign()一样，当改变a的第二层属性时，b的属性值也改变了</p></div><h4 id="浅拷贝-Array-slice-方法"><a href="#浅拷贝-Array-slice-方法" class="headerlink" title="浅拷贝-Array.slice()方法"></a>浅拷贝-<a href="https://www.w3school.com.cn/js/jsref_slice_array.asp">Array.slice()</a>方法</h4><p><code>slice(start [,end])</code>方法不会改变原数组，会返回一个新的数组，包含从 start 到 end （不包括该元素）的元素。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a = [<span class="number">0</span>, <span class="string">&#x27;1&#x27;</span>, [<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]]</span><br><span class="line"><span class="keyword">let</span> b = a.<span class="title function_">slice</span>(<span class="number">0</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b) <span class="comment">// [0, &quot;1&quot;, [2, 3, 4]]</span></span><br><span class="line">a[<span class="number">0</span>] = <span class="number">123</span></span><br><span class="line">a[<span class="number">2</span>][<span class="number">0</span>] = <span class="number">234</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a) <span class="comment">// [123, &quot;1&quot;, [234, 3, 4]]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b) <span class="comment">// [0, &quot;1&quot;, [234, 3, 4]]</span></span><br></pre></td></tr></table></figure><div class="note red no-icon flat"><p>这个方法只能浅拷贝数组使用</p></div><h3 id="深拷贝"><a href="#深拷贝" class="headerlink" title="深拷贝"></a>深拷贝</h3><p>深拷贝会拷贝对象的所有属性，相当于创建一个新的对象，深拷贝的对象与原对象除了值相同外不存在互相的引用关系，当改变一个对象属性时另一个不会发生变化，深拷贝相对于浅拷贝开销较大，拷贝前后对象互不影响。</p><h4 id="深拷贝-JSON-parse-JSON-stringify"><a href="#深拷贝-JSON-parse-JSON-stringify" class="headerlink" title="深拷贝-JSON.parse()  JSON.stringify()"></a>深拷贝-<a href="https://www.w3school.com.cn/js/js_json_parse.asp">JSON.parse()</a>  <a href="https://www.w3school.com.cn/js/js_json_stringify.asp">JSON.stringify()</a></h4><p>JSON.parse(JSON.stringify(Object))，原理是将引用类型对象转换成JSON字符串，再将字符串转换为一个对象，这时返回的对象会成为一个新的引用类型对象。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;abc&#x27;</span>,</span><br><span class="line">    <span class="attr">shop</span>: &#123;</span><br><span class="line">        <span class="attr">price</span>: <span class="number">100</span>,</span><br><span class="line">        <span class="attr">title</span>: <span class="literal">undefined</span>,</span><br><span class="line">        <span class="attr">avatar</span>: <span class="literal">null</span>,</span><br><span class="line">        <span class="attr">read</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;&#125;,</span><br><span class="line">       <span class="attr">symbol</span>: <span class="title class_">Symbol</span>(<span class="string">&#x27;bcd&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> b = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(a))</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b) <span class="comment">// &#123;name: &quot;abc&quot;, shop: &#123;price: 100, avatar: null&#125;&#125;</span></span><br><span class="line"><span class="comment">// 当a的值改变时</span></span><br><span class="line">a.<span class="property">name</span> = <span class="string">&#x27;def&#x27;</span> <span class="comment">// 第一层属性</span></span><br><span class="line">a.<span class="property">shop</span>.<span class="property">price</span> = <span class="number">200</span> <span class="comment">// 第二层属性</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a) <span class="comment">// &#123;name: &quot;def&quot;, shop: &#123;price: 200, title: undefined, avatar: null, read: ƒ (), symbol: Symbol(bcd)&#125;&#125;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b) <span class="comment">// &#123;name: &quot;abc&quot;, shop: &#123;price: 100, avatar: null&#125;&#125;</span></span><br></pre></td></tr></table></figure><div class="note danger flat"><p>这个方法拷贝对象时，会有以下问题：</p><ul><li>会忽略 <code>undefined</code></li><li>会忽略 <code>symbol</code></li><li>会忽略函数</li><li>不能解决循环引用的对象(会报错Uncaught TypeError: Converting circular structure to JSON)</li><li>不能正确处理<code>new Date()</code>（会将时间对象转换为字符串时间）</li><li>不能处理正则</li></ul></div><h4 id="深拷贝-递归"><a href="#深拷贝-递归" class="headerlink" title="深拷贝-递归"></a>深拷贝-递归</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">deepCopy</span>(<span class="params"> source </span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">typeof</span> source === <span class="string">&#x27;object&#x27;</span> &amp;&amp; source !== <span class="literal">null</span>) <span class="keyword">return</span> source; <span class="comment">//如果不是对象的话直接返回</span></span><br><span class="line">    <span class="keyword">let</span> target = <span class="title class_">Array</span>.<span class="title function_">isArray</span>( source ) ? [] : &#123;&#125; <span class="comment">//数组兼容</span></span><br><span class="line">    <span class="keyword">for</span> ( <span class="keyword">var</span> k <span class="keyword">in</span> source ) &#123;</span><br><span class="line">     <span class="keyword">if</span> (source.<span class="title function_">hasOwnProperty</span>(k)) &#123;</span><br><span class="line">      <span class="keyword">if</span> ( <span class="keyword">typeof</span> source[ k ] === <span class="string">&#x27;object&#x27;</span> ) &#123;</span><br><span class="line">             target[ k ] = <span class="title function_">deepCopy</span>( source[ k ] )</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             target[ k ] = source[ k ]</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> target</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="深拷贝-获取所有属性逐个添加"><a href="#深拷贝-获取所有属性逐个添加" class="headerlink" title="深拷贝-获取所有属性逐个添加"></a>深拷贝-获取所有属性逐个添加</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">copyObject</span>(<span class="params">orig</span>) &#123;</span><br><span class="line">   <span class="comment">// Object.create(prototype) 使用原型创建新的对象</span></span><br><span class="line">   <span class="comment">// Object.getPrototypeOf(obj) 返回对象的原型</span></span><br><span class="line">    <span class="keyword">var</span> copy = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="title class_">Object</span>.<span class="title function_">getPrototypeOf</span>(orig));</span><br><span class="line">    <span class="title function_">copyOwnPropertiesFrom</span>(copy, orig);</span><br><span class="line">    <span class="keyword">return</span> copy;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">copyOwnPropertiesFrom</span>(<span class="params">target, source</span>) &#123;</span><br><span class="line">    <span class="comment">// Object.getOwnPropertyNames 返回指定对象的所有属性名组成的数组（包含不可枚举属性）</span></span><br><span class="line">    <span class="comment">// Object.getOwnPropertyDescriptor 返回对象上属性对应的属性描述符</span></span><br><span class="line">    <span class="comment">// Object.defineProperty 直接在对象上定义一个新属性，或者修改一个现有属性</span></span><br><span class="line">    <span class="title class_">Object</span></span><br><span class="line">    .<span class="title function_">getOwnPropertyNames</span>(source)</span><br><span class="line">    .<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">propKey</span>) &#123;</span><br><span class="line">      <span class="keyword">var</span> desc = <span class="title class_">Object</span>.<span class="title function_">getOwnPropertyDescriptor</span>(source, propKey);</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> desc.<span class="property">value</span> === <span class="string">&#x27;object&#x27;</span>) &#123;</span><br><span class="line">        target[propKey] = <span class="title function_">copyObject</span>(source[propKey]);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(target, propKey, desc);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> target;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><blockquote><p>后两个方法原文地址： <a href="https://www.cnblogs.com/dobeco/p/11295316.html">https://www.cnblogs.com/dobeco/p/11295316.html</a></p></blockquote><blockquote><p>方法参考链接：</p><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/create">https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/create</a></p><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/getPrototypeOf">https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/getPrototypeOf</a></p><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/getOwnPropertyNames">https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/getOwnPropertyNames</a></p><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/getOwnPropertyDescriptor">https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/getOwnPropertyDescriptor</a></p><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty">https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> JavaScript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaScript </tag>
            
            <tag> JS </tag>
            
            <tag> 深拷贝 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hexo新建文章</title>
      <link href="/2021/08/17/Hexo%E6%96%B0%E5%BB%BA%E6%96%87%E7%AB%A0/"/>
      <url>/2021/08/17/Hexo%E6%96%B0%E5%BB%BA%E6%96%87%E7%AB%A0/</url>
      
        <content type="html"><![CDATA[<h2 id="Typora"><a href="#Typora" class="headerlink" title="Typora"></a>Typora</h2><p>一款编写Markdown的软件</p><h3 id="常用快捷键"><a href="#常用快捷键" class="headerlink" title="常用快捷键"></a>常用快捷键</h3><p>标题： Ctrl/Command + 1、2、3…对应一、二、三级标题</p><p><strong>加粗</strong>：Ctrl/Command + B</p><p><em>斜体</em>：Ctrl/Command + I</p><p><u>下划线</u>：Ctrl/Command + U</p><p><del>删除线</del>：control + shift + `</p><p><code>代码片段</code>：control + `</p><p>代码块：option + command + c</p><p><a href="">链接</a>：command + k</p><p>取消格式：再按相同快捷键</p><p>有序列表：数字+点+空格</p><p>任务列表： +/-加空格</p><p>嵌套列表：Tab</p><p>插入表格：option + command + t</p><p>引用：输入&gt;加空格，或者option + command + q</p><h2 id="Hexo"><a href="#Hexo" class="headerlink" title="Hexo"></a>Hexo</h2><h3 id="创建一个md文件"><a href="#创建一个md文件" class="headerlink" title="创建一个md文件"></a>创建一个md文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hexo new &lt;title&gt;</span><br><span class="line">hexo new <span class="string">&#x27;标题&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="布局（layout）"><a href="#布局（layout）" class="headerlink" title="布局（layout）"></a>布局（layout）</h3><ul><li>创建md时，我们可以指定布局</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hexo new [layout] &lt;title&gt;</span><br><span class="line">hexo new page <span class="string">&#x27;我的页面&#x27;</span></span><br></pre></td></tr></table></figure><ul><li><p>布局有三种：<code>post</code>（文章）、<code>draft</code>（草稿）、<code>page</code>（页面）</p><p>在新建文件时，Hexo会根据<code>scaffolds</code>文件对应的文件来建立md</p></li></ul><p><img src="https://cdn.chrelyonly.cf/gh/011-01-10-110/static_resources@master/20210817111500.jpg" alt="示例"></p><ul><li>如果没有指定默认为<code>post</code>，可以在站点配置文件修改<code>default_layout</code>参数来修改默认布局。</li></ul><blockquote><p>对于独立页面来说，Hexo会创建一个以标题为名字的文件</p></blockquote><h3 id="草稿（draft）"><a href="#草稿（draft）" class="headerlink" title="草稿（draft）"></a>草稿（draft）</h3><p><code>draft</code>会被保存到<code>source/_drafts</code>文件夹中，但不会显示在页面上，如果不想文章显示在页面上，可以放到<code>_drafts</code>文件夹中。</p><ul><li>可以使用 <code>--draft</code> 参数查看草稿</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo server --draft</span><br></pre></td></tr></table></figure><ul><li><p>还可以在站点配置文件把<code>render_drafts</code>参数设为<code>true</code>来预览草稿</p></li><li><p>可以通过<code>publish</code>指令将草稿发布文章或页面，他将会被转移到指定文件夹</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo publish [layout] &lt;title&gt;</span><br></pre></td></tr></table></figure><h3 id="Fornt-matter"><a href="#Fornt-matter" class="headerlink" title="Fornt-matter"></a>Fornt-matter</h3><p>当创建一个md文件后，最上方的<code>---</code>分割的区域，用于指定个别文件的变量。</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: Hexo新建文章</span><br><span class="line"><span class="section">date: 2021-08-17 09:30:25</span></span><br><span class="line"><span class="section">---</span></span><br></pre></td></tr></table></figure><blockquote><p>在Typora中首行输入<code>---</code>，然后回车就可以输入<code>Fornt-matter</code>了。</p></blockquote><p>Front-matter预定参数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">layout  布局  默认为true，如果你不想你的文章被处理，可以设置为false</span><br><span class="line">title  标题  标题会显示在最上方居中位置     </span><br><span class="line">date  建立日期    如果不指定则为默认值-文件创建日期，可以自定义。</span><br><span class="line">update  更新日期  如果不指定则为默认值-文件修改后重新生成静态文件的日期。</span><br><span class="line">comments  是否开启文章的评论功能 默认值为true</span><br><span class="line">tags  标签（不适用于页面page布局）</span><br><span class="line">categoreies  分类（不适用于页面page布局）</span><br><span class="line">permalink  覆盖文章网址</span><br><span class="line">keywords  仅用于 meta 标签和 Open Graph 的关键词（不推荐使用）</span><br></pre></td></tr></table></figure><h3 id="为文章添加分类标签"><a href="#为文章添加分类标签" class="headerlink" title="为文章添加分类标签"></a>为文章添加分类标签</h3><p>只有文章（post布局）支持分类和标签，需要在<code>Front-matter</code>中设置。分类有层级关系，标签没有。</p><p>举个例子：<br>1）下面文章它的标签是：Hexo、博客<br>2）分类是： 个人博客 &gt; Hexo博客<br>3）“Hexo博客” 是 “个人博客” 的子分类</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">categories:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">个人博客（第一层级）</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">Hexo博客（第二层级）</span></span><br><span class="line"><span class="attr">tags:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">Hexo</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">博客</span></span><br></pre></td></tr></table></figure><p>为文章添加多个分类</p><p>1）下面文章属于三个分类：日常 &gt; 生活，日常 &gt; 随想，日记<br>2）其中生活、随想为日常的子分类，日常和日记为同级分类</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">categories:</span></span><br><span class="line"><span class="bullet">-</span> [<span class="string">日常</span>, <span class="string">生活</span>]</span><br><span class="line"><span class="bullet">-</span> [<span class="string">日常</span>, <span class="string">随想</span>]</span><br><span class="line"><span class="bullet">-</span> [<span class="string">日记</span>]</span><br></pre></td></tr></table></figure><h3 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h3><h4 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h4><ul><li><p>清除缓存：<code>hexo clean</code></p></li><li><p>生成静态文件：<code>hexo generate</code>可简写为 <code>hexo g</code></p></li><li><p>启动服务器：<code>hexo server</code>或者 <code>hexo s</code> 常用参数：<code>-p（--port）</code>重设端口</p></li><li><p>部署：<code>hexo deploy</code>可简写为<code>hexo d</code>，用于将网站部署到服务器上。（暂时用不到，目前都是在本地，后面我们将博客托管到<code>GitHub Pages</code>或<code>Gitee Pages</code>时才会用到此命令）<br>常用参数：<code>-g（--generate）</code>，<code>hexo d -g</code>部署前预先生成静态文件，等同于 <code>hexo g -d</code></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo练习 </tag>
            
            <tag> Typora </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
